<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø£Ø¯Ø§Ø© Ø§Ù„Ø¨Ø­Ø«</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --border:#e6e8ef; --text:#1f2937; --muted:#6b7280;
      --blue:#2563eb; --blueH:#1d4ed8; --green:#16a34a; --greenH:#15803d;
      --red:#dc2626; --redH:#b91c1c; --amber:#f59e0b; --violet:#8b5cf6;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:14px; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}

    .container{max-width:1100px; margin:0 auto; display:grid; gap:12px}
    @media(min-width:1060px){
      .container{ grid-template-columns: 1fr 1fr; align-items:start; }
      #advCard{ grid-column:1 }
      #personCard{ grid-column:2 }
      .span2{ grid-column:1 / span 2; }
    }
    @media(max-width:1059px){
      #advCard{ order:1 }
      #personCard{ order:2 }
    }

    .card{background:#fff; border:1px solid var(--border); border-radius:14px; padding:12px}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:nowrap}
    .row.stretch > *{flex:1}
    label.small{font-size:12px; color:var(--muted); margin-bottom:6px; display:block}
    input[type="text"], input[type="number"], select{
      width:100%; padding:10px 12px; border:1px solid var(--border);
      border-radius:10px; font-size:14px; background:#fff
    }
    button{border:0; border-radius:10px; padding:10px 12px; font-weight:600; cursor:pointer}
    .btn-blue{background:var(--blue); color:#fff} .btn-blue:hover{background:var(--blueH)}
    .btn-green{background:var(--green); color:#fff} .btn-green:hover{background:var(--greenH)}
    .btn-red{background:var(--red); color:#fff} .btn-red:hover{background:var(--redH)}
    .btn-ghost{background:#0000; border:1px solid var(--border); color:var(--text)}
    .muted{font-size:11px; color:var(--muted)}

    .results{
      min-height:120px; display:flex; flex-direction:column; justify-content:center; align-items:center;
      gap:10px; text-align:center; background:white; border-radius:12px; padding:16px;
      box-shadow:0 2px 6px rgba(0,0,0,0.06);
    }
    .badges{display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center}
    .badge{font-size:12px; font-weight:700; padding:6px 10px; border-radius:999px; border:1px solid transparent; letter-spacing:.2px;}
    .badge--admin{ background:#fff7ed; color:#9a3412; border-color:#fdba74; }
    .badge--withdraw{ background:#eff6ff; color:#1d4ed8; border-color:#93c5fd; }
    .badge--agent{ background:#ecfdf5; color:#065f46; border-color:#6ee7b7; }
    .badge--missing{ background:#f9fafb; color:#6b7280; border-color:#ef4444; }
    .badge--loading{ background:#f3f4f6; color:#6b7280; border-color:#e5e7eb; }
    .badge--dup{ background:#fef2f2; color:#b91c1c; border-color:#fca5a5; }

    .amountBig{ font-size:44px; font-weight:900; line-height:1; }
    .subline{ font-size:12px; color:#6b7280; }

    .lastid{display:inline-flex; gap:6px; align-items:center; padding:6px 8px; border-radius:999px;
      border:1px solid var(--border); background:#fff; cursor:pointer; font-size:12px}

    #resultsBox, #advCard, #personCard { position:relative; }
    @keyframes flashGlowBlue  { 0%{box-shadow:0 0 0 0 rgba(59,130,246,0)} 25%{box-shadow:0 0 0 6px rgba(59,130,246,.22)} 100%{box-shadow:0 0 0 0 rgba(59,130,246,0)} }
    @keyframes flashGlowGreen { 0%{box-shadow:0 0 0 0 rgba(16,185,129,0)} 25%{box-shadow:0 0 0 6px rgba(16,185,129,.22)} 100%{box-shadow:0 0 0 0 rgba(16,185,129,0)} }
    .flash-blue { animation:flashGlowBlue  .42s ease; }
    .flash-green{ animation:flashGlowGreen .42s ease; }

    .row.stretch > button{ order:-1; flex:0 0 auto; min-width:110px; }
    .row.stretch > input, .row.stretch > select{ flex:1 1 auto; min-width:0; }

    /* Dark */
    body.dark{ background:#0f1115; color:#e5e7eb;}
    body.dark .card{ background:#1f232b; border-color:#2d323c; color:#e5e7eb; }
    body.dark input, body.dark select{ background:#111827; color:#f9fafb; border-color:#374151;}
    body.dark .results{ background:#1f232b; }
    body.dark .amountBig{ color:#22c55e; text-shadow:0 0 6px rgba(34,197,94,.7); }
    body.dark .lastid{ background:#111827; border-color:#2a2f39; color:#e5e7eb }
    body.dark .muted{ color:#cbd5e1; }
    body.dark .btn-ghost{ color:#e5e7eb; }
    body.dark .badge{ border-color:#374151; }

    /* iOS toggles */
    .ios-toggle{display:inline-flex;align-items:center;gap:10px;cursor:pointer;user-select:none}
    .ios-toggle input{opacity:0;width:0;height:0}
    .slider{position:relative;display:inline-block;width:50px;height:28px;background:#cfcfcf;border-radius:28px;transition:.25s}
    .slider:before{content:"";position:absolute;left:3px;bottom:3px;width:22px;height:22px;background:#fff;border-radius:50%;transition:.25s}
    input:checked + .slider{background:#34c759}
    input:checked + .slider:before{transform:translateX(22px)}
    body.dark input:checked + .slider{background:#22c55e}
    .switch-label{font-size:13px;font-weight:600;white-space:nowrap}
    .toggle-chip{display:flex;align-items:center;gap:10px;padding:6px 10px;border:1px solid var(--border);border-radius:14px;background:#fafafa}
    body.dark .toggle-chip{background:#111827;border-color:#2d323c}
    .toggles-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  
/* Mobile-first tweaks */
html, body { max-width: 100%; overflow-x: hidden; }
.container { width: 100%; max-width: 940px; margin: 0 auto; padding: 10px; }
@media (max-width: 640px){
  .container{ max-width: 100% !important; padding: 12px !important; }
  .card{ border-radius: 14px !important; }
  .row{ flex-wrap: wrap !important; }
  input, button, select{ font-size: 16px !important; }
}

</style>
</head>
<body>
  <div class="container">

    <!-- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
    <div class="card span2" id="loadCard">
      <div class="row stretch">
        <button id="reloadBtn" class="btn-red">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>
      <div id="loadNote" class="muted" style="margin-top:6px"></div>
    </div>

    <!-- Ø§Ù„Ø¨Ø­Ø« -->
    <div class="card" id="searchCard">
      <label class="small">ID Ù„Ù„Ø¨Ø­Ø«</label>
      <div class="row stretch">
        <button id="pasteSearchBtn" class="btn-blue">Ù„ØµÙ‚ Ø«Ù… Ø¨Ø­Ø«</button>
        <input id="idInput" type="text" placeholder="Ø£Ø¯Ø®Ù„ ID Ù‡Ù†Ø§" autocomplete="off" inputmode="numeric">
      </div>
      <div class="row" style="margin-top:6px; justify-content:space-between">
        <div id="pasteHint" class="muted"></div>
        <div id="lastIdPill" class="lastid" style="display:none">Ø¢Ø®Ø± ID: <b id="lastIdText"></b></div>
      </div>
    </div>

    <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
    <div class="card results" id="resultsBox">
      <div class="badges">
        <span id="statusBadge" class="badge badge--loading">â€”</span>
        <span id="dupBadge" class="badge badge--dup" style="display:none">Ù…ÙƒØ±Ø±</span>
        <span id="statusChipsRow"></span>
      </div>
      <!-- Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø¹Ù…ÙˆØ¯ B -->
      <div id="nameText" class="subline">â€”</div>
            <div id="amountText" class="amountBig">â€”</div>
      <div id="multiText" class="subline"></div>
      <div id="extraDupInfo" class="muted" style="margin-top:4px"></div>
    </div>

    <!-- Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© -->
    <div class="card" id="advCard">
      <button id="advRunBtn" class="btn-green" style="width:100%;padding:14px;font-size:16px;font-weight:700;margin-bottom:12px">
        ØªÙ†ÙÙŠØ° (Ø­Ø³Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©)
      </button>
      <div id="advNote" class="muted" style="margin-bottom:12px"></div>

      <div class="row" style="gap:8px; align-items:center">
        <label class="small" style="margin:0;min-width:60px">Ø§Ù„Ù‡Ø¯Ù</label>
        <select id="sheetSelect" style="flex:1"></select>

        <label class="small" style="margin:0;min-width:70px">Ø§Ù„ØªÙ†ÙÙŠØ°</label>
        <select id="targetMode" style="flex:1">
          <option value="agent">Ø§Ù„ÙˆÙƒÙŠÙ„ ÙÙ‚Ø·</option>
          <option value="both" selected>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© + Ø§Ù„ÙˆÙƒÙŠÙ„</option>
        </select>

        <button id="refreshSheetsBtn" class="btn-ghost" title="ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚">â†»</button>
      </div>

      <div class="row" style="margin-top:10px;gap:14px;flex-wrap:wrap">
        <div style="flex:1;display:flex;align-items:center;gap:8px">
          <input id="adminColor" type="color" value="#fde68a"
            style="width:38px;height:32px;border:1px solid var(--border);border-radius:8px;padding:0" />
          <label class="small" style="margin:0">Ù„ÙˆÙ† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</label>
        </div>
        <div style="flex:1;display:flex;align-items:center;gap:8px">
          <input id="withdrawColor" type="color" value="#ddd6fe"
            style="width:38px;height:32px;border:1px solid var(--border);border-radius:8px;padding:0" />
          <label class="small" style="margin:0">Ù„ÙˆÙ† Ø³Ø­Ø¨ ÙˆÙƒØ§Ù„Ø©</label>
        </div>
      </div>

      <div class="row stretch" style="margin-top:10px">
        <input id="newSheetName" type="text" placeholder="Ø§Ø³Ù… ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)">
        <button id="createSheetBtn" class="btn-ghost">Ø¥Ù†Ø´Ø§Ø¡</button>
      </div>

      <div class="row" style="margin-top:12px; align-items:center; gap:12px; flex-wrap:wrap">
        <div class="row" style="gap:8px; align-items:center">
          <label class="small" style="margin:0">Ø§Ù„Ø®ØµÙ… %</label>
          <input id="discountInput" type="number" min="0" max="100" value="0" step="1" style="width:110px">
        </div>

        <div class="toggle-chip">
          <span class="switch-label">Ø§Ù„Ø®ØµÙ… Ù„Ø­Ø¸ÙŠÙ‹Ø§</span>
          <label class="ios-toggle">
            <input id="applyDiscountToMessage" type="checkbox">
            <span class="slider"></span>
          </label>
        </div>

        <div class="toggle-chip">
          <span class="switch-label">ØªØµØ­ÙŠØ­ Ø§Ù„Ø±Ø§ØªØ¨</span>
          <label class="ios-toggle">
            <input id="enableSalaryCorrection" type="checkbox">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      <div id="aiMountHere"></div>
      <div id="afterAiHook"></div>
    </div>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ø­Ø¨ Ø§Ù„Ù€ID -->
    <div class="card" id="personCard">
      <div class="row" style="justify-content:space-between; align-items:center">
        <strong>Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ø­Ø¨ Ø§Ù„Ù€ID</strong>
        <div class="row" style="gap:6px; flex:0 0 auto">
          <button id="copyMsgBtn" class="btn-green">Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
          <button id="colorAllBtn" class="btn-ghost" title="ØªÙ„ÙˆÙŠÙ† ÙƒÙ„ Ø§Ù„Ù€IDs Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ Ø¨Ø³Ø±Ø¹Ø©">ØªÙ„ÙˆÙŠÙ† Ø§Ù„ÙƒÙ„</button>
        </div>
      </div>
      <div id="personNote" class="muted" style="margin-top:6px">â€”</div>
      <textarea id="personMsg" rows="8" style="width:100%; margin-top:8px; padding:10px; border:1px solid var(--border); border-radius:10px; font-family:inherit; font-size:14px" readonly></textarea>
    </div>

    <!-- ===== Ø£Ø¯ÙˆØ§Øª Ø³Ø±ÙŠØ¹Ø© (Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø³ØªÙ‚Ù„Ø©ØŒ Ù†ÙØ³ Ø§Ù„Ù€ IDs Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©) ===== -->
<style>
  /* Ø´Ø¨ÙƒØ© Ù…Ø±ØªÙ‘Ø¨Ø© Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§ØªØŒ ØªØªÙƒÙŠÙ‘Ù Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
  #quickTools.qtools-wrap{
    padding:0; background:transparent; border:0; box-shadow:none;
  }
  #qtGrid{
    display:grid; gap:10px;
    grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
  }
  #qtGrid .card{
    margin:0; /* Ù†Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ */
  }

  /* Ø¹Ù†ÙˆØ§Ù† ØµØºÙŠØ± Ø£Ù†ÙŠÙ‚ Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ø¨Ø·Ø§Ù‚Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) */
  .qt-title{
    font-size:14px; font-weight:800; margin:0 0 8px 0;
  }

  /* ØµÙ Ø¯Ø§Ø®Ù„ÙŠ Ù…Ø±ØªØ¨ */
  .qt-row{
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }

  /* ÙƒØ¨Ø³ Ø²Ø± ØµØºÙŠØ± Ù„Ù„Ø¹Ø¯Ø§Ø¯ */
  .qt-pill{
    display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    border:1px solid var(--border); border-radius:12px; padding:8px 12px;
  }

  /* ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„: Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ */
  @media (max-width:1059px){
    #qtGrid{ grid-template-columns: 1fr; }
    .qt-row .btn-ghost, .qt-row button, .qt-row label{ width:100%; }
    .qt-pill{ width:100%; justify-content:space-between; }
  }
</style>

<div id="quickTools" class="qtools-wrap card span2">
  <div id="qtGrid">

    <!-- Ø¨Ø·Ø§Ù‚Ø©: Ø§Ù„ÙˆØ¶Ø¹ -->
    <div class="card" id="qtModeCard">
      <div class="qt-title">Ø§Ù„ÙˆØ¶Ø¹</div>
      <div class="qt-row">
        <button id="qtMode" class="btn-ghost">ğŸŒ™ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†</button>
      </div>
    </div>

    <!-- Ø¨Ø·Ø§Ù‚Ø©: Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div class="card" id="qtHideLoadCard">
      <div class="qt-title">Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>
      <div class="qt-row">
        <button id="qtHideLoad" class="btn-ghost">ğŸ™ˆ Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„</button>
      </div>
    </div>

    <!-- Ø¨Ø·Ø§Ù‚Ø©: Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
    <div class="card" id="qtPersonCard">
      <div class="qt-title">Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
      <div class="qt-row" style="gap:8px">
        <button id="qtHidePerson" class="btn-ghost">ğŸ™ˆ Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <label class="ios-toggle" style="margin-inline-start:6px">
          <span class="switch-label">ØªØ¹Ø·ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
          <input id="qtDisablePerson" type="checkbox">
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <!-- Ø¨Ø·Ø§Ù‚Ø©: Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ -->
    <div class="card" id="qtCounterCard">
      <div class="qt-title">Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯</div>
      <div class="qt-row">
        <div class="qt-pill" style="flex:1">
          <span class="muted">Ø§Ù„Ù…Ù„ÙˆÙ‘Ù†:</span><b id="qtColored">â€”</b>
          <span style="width:10px"></span>
          <span class="muted">ØºÙŠØ± Ø§Ù„Ù…Ù„ÙˆÙ‘Ù†:</span><b id="qtUncolored">â€”</b>
        </div>
        <button id="qtRefreshCnt" class="btn-ghost" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯">â†» ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>
  </div>

  </div>

  <script>
    // Ø¹Ù†Ø§ØµØ± Ø¹Ø§Ù…Ø©
    const reloadBtn      = document.getElementById('reloadBtn');
    const loadNote       = document.getElementById('loadNote');

    const idInput        = document.getElementById('idInput');
    const pasteSearchBtn = document.getElementById('pasteSearchBtn');
    const pasteHint      = document.getElementById('pasteHint');

    const resultsBox  = document.getElementById('resultsBox');
    const statusBadge = document.getElementById('statusBadge');
    const dupBadge    = document.getElementById('dupBadge');
    const amountText  = document.getElementById('amountText');
    const multiText   = document.getElementById('multiText');
    const extraDupInfo= document.getElementById('extraDupInfo');
    const justColored = Object.create(null);
    
    // Ø¹Ù†ØµØ± Ù„Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù…Ù† Ø¹Ù…ÙˆØ¯ B)
    const nameText   = document.getElementById('nameText');
const advCard  = document.getElementById('advCard');
    const advNote  = document.getElementById('advNote');
    const sheetSelect   = document.getElementById('sheetSelect');
    const refreshSheetsBtn = document.getElementById('refreshSheetsBtn');
    const newSheetName  = document.getElementById('newSheetName');
    const createSheetBtn= document.getElementById('createSheetBtn');
    const adminColor    = document.getElementById('adminColor');
    const withdrawColor = document.getElementById('withdrawColor');
    const targetModeSel = document.getElementById('targetMode');
    const advRunBtn     = document.getElementById('advRunBtn');

    const discountInput = document.getElementById('discountInput');
    const applyDiscountToMessage = document.getElementById('applyDiscountToMessage');
    const enableSalaryCorrection = document.getElementById('enableSalaryCorrection');

    // Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®Øµ
    const personCardEl = document.getElementById('personCard');
    const personNote   = document.getElementById('personNote');
    const personMsg    = document.getElementById('personMsg');
    const copyMsgBtn   = document.getElementById('copyMsgBtn');
    const colorAllBtn  = document.getElementById('colorAllBtn');

    // Ø¢Ø®Ø± ID
    const lastIdPill = document.getElementById('lastIdPill');
    const lastIdText = document.getElementById('lastIdText');

    // Ø£Ø¯ÙˆØ§Øª Ø³Ø±ÙŠØ¹Ø©
    const qtColored = document.getElementById('qtColored');
    const qtUncolored = document.getElementById('qtUncolored');
    const qtMode = document.getElementById('qtMode');
    const qtHide = document.getElementById('qtHideLoad');

    const qtHidePerson = document.getElementById('qtHidePerson');
    const qtDisablePerson = document.getElementById('qtDisablePerson');

    // Ø­Ø§Ù„Ø©
    let localMap = null;
    let lastResult = null;
    let lastProfileIds = [];
    let lastBaseId = '';

    const fmt = n => {
      const x = Number(n);
      return isNaN(x) ? 'â€”' : new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(x);
    };

    /******** Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¥Ø®ÙØ§Ø¡/ØªØ¹Ø·ÙŠÙ„) ********/
    function isPersonFeatureDisabled(){ return localStorage.getItem('disable_person_feature') === '1'; }
    function isPersonHidden(){ return localStorage.getItem('hide_person_section') === '1'; }

    function applyPersonVisibility(){
      qtDisablePerson.checked = isPersonFeatureDisabled();
      const hidden = isPersonHidden() || isPersonFeatureDisabled();
      personCardEl.style.display = hidden ? 'none' : '';
      if (isPersonFeatureDisabled()){
        personMsg.value = '';
        personNote.textContent = 'â€”';
        copyMsgBtn.disabled = true;
        colorAllBtn.disabled = true;
      } else {
        copyMsgBtn.disabled = false;
        colorAllBtn.disabled = false;
      }
      qtHidePerson.textContent = hidden ? 'ğŸ‘€ Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' : 'ğŸ™ˆ Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    }
    qtHidePerson.addEventListener('click', ()=>{
      const cur = isPersonHidden();
      localStorage.setItem('hide_person_section', cur ? '0':'1');
      applyPersonVisibility();
    });
    qtDisablePerson.addEventListener('change', ()=>{
      const en = !!qtDisablePerson.checked;
      localStorage.setItem('disable_person_feature', en ? '1':'0');
      applyPersonVisibility();
    });

    /******** Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© UI ********/
    function flash(el, cls){
      el.classList.remove('flash-blue','flash-green');
      void el.offsetWidth;
      el.classList.add(cls);
    }
    function saveLastId(id){
      try { localStorage.setItem('last_id', id); } catch(_){}
      lastIdText.textContent = id || '';
      lastIdPill.style.display = id ? 'inline-flex' : 'none';
    }
    function loadLastId(){
      let v = '';
      try { v = localStorage.getItem('last_id') || ''; } catch(_){}
      if (v){ lastIdText.textContent = v; lastIdPill.style.display = 'inline-flex'; }
      else { lastIdPill.style.display = 'none'; }
    }
    lastIdPill.addEventListener('click', ()=>{
      const v = lastIdText.textContent || '';
      if (!v) return;
      idInput.value = v;
      doSearch();
    });

    /******** ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ********/
    function fillSheets(){
      google.script.run
        .withSuccessHandler(arr=>{
          sheetSelect.innerHTML = '';
          (arr||[]).forEach(n=>{
            const o = document.createElement('option');
            o.value = o.textContent = n;
            sheetSelect.appendChild(o);
          });
        })
        .withFailureHandler(err=> advNote.textContent = 'Ø®Ø·Ø£: '+(err?.message||'')) 
        .getAdminSheets();
    }

    /******** ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ********/
    function setLoadBtnState(ok){
      if (ok===true){ reloadBtn.classList.remove('btn-red'); reloadBtn.classList.add('btn-green'); }
      else if (ok===false){ reloadBtn.classList.remove('btn-green'); reloadBtn.classList.add('btn-red'); }
    }
    function loadData(){
      setLoadBtnState(false);
      loadNote.textContent = 'â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦';
      google.script.run
        .withSuccessHandler(srv=>{
          const baseMsg = srv?.message || 'ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.';
          google.script.run
            .withSuccessHandler(res=>{
              if(!res || !res.ok){
                loadNote.textContent = baseMsg + ' | âš ï¸ ÙØ´Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ: ' + (res?.message||'');
                setLoadBtnState(false);
                return;
              }
              localMap = res.map || null;
              const st = res.stats || {};
              loadNote.textContent = `${baseMsg} | Ù…Ø­Ù„ÙŠ: ${st.agentRows||0} ØµÙ / ${st.agentUnique||0} ID.`;
              setLoadBtnState(true);
              refreshCountsLive();
            })
            .withFailureHandler(err=>{
              loadNote.textContent = baseMsg + ' | âš ï¸ Ø®Ø·Ø£ Ø¨Ø§Ù„Ù…Ø­Ù„ÙŠ: ' + (err?.message||'');
              setLoadBtnState(false);
            })
            .getSearchSnapshotLight();
        })
        .withFailureHandler(err=>{
          loadNote.textContent = 'âš ï¸ Ø®Ø·Ø£ Ø¨Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + (err?.message||'');
          setLoadBtnState(false);
        })
        .loadDataIntoCache();
    }
    reloadBtn.addEventListener('click', loadData);
    createSheetBtn.addEventListener('click', ()=>{
  const name = (newSheetName.value || '').trim();
  if (!name){ advNote.textContent = 'âš ï¸ Ø§ÙƒØªØ¨ Ø§Ø³Ù… ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©'; return; }
  google.script.run
    .withSuccessHandler(msg=>{
      advNote.textContent = msg || 'ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ âœ…';
      // Ø­Ø¯Ù‘Ø« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ­Ø¯Ù‘Ø¯ Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      google.script.run
        .withSuccessHandler(arr=>{
          sheetSelect.innerHTML = '';
          (arr||[]).forEach(n=>{
            const o = document.createElement('option');
            o.value = o.textContent = n;
            sheetSelect.appendChild(o);
          });
          // Ø­Ø§ÙˆÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„ØªÙŠ Ø£Ù†Ø´Ø£Ù†Ø§Ù‡Ø§
          const opt = Array.from(sheetSelect.options).find(o => o.value === name);
          if (opt) sheetSelect.value = name;
          newSheetName.value = '';
        })
        .getAdminSheets();
    })
    .withFailureHandler(err=>{
      advNote.textContent = 'Ø®Ø·Ø£: ' + (err?.message || '');
    })
    .createAdminSheet(name);
});

    /******** Ù„ØµÙ‚ Ø«Ù… Ø¨Ø­Ø« / Ø¥Ù†ØªØ± ********/
    pasteSearchBtn.addEventListener('click', async ()=>{
      pasteHint.textContent = '';
      try{
        const txt = await navigator.clipboard.readText();
        if (txt && txt.trim()){
          idInput.value = txt.trim();
          doSearch();
          return;
        }
      }catch(_){}
      idInput.focus(); idInput.select();
      pasteHint.textContent = 'Ø§Ù„ØµÙ‚ ÙŠØ¯ÙˆÙŠÙ‹Ø§ ÙˆØ³ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§â€¦';
      const once = ()=>{ pasteHint.textContent = ''; idInput.removeEventListener('input', once); setTimeout(doSearch, 0); };
      idInput.addEventListener('input', once, { once:true });
    });
    idInput.addEventListener('paste', ()=> setTimeout(doSearch, 0));
    idInput.addEventListener('keyup', e=>{ if (e.key === 'Enter') doSearch(); });

    /******** Ø±Ù†Ø¯Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ********/
    function clearDupUI(){
      dupBadge.style.display = 'none';
      dupBadge.textContent = 'Ù…ÙƒØ±Ø±';
      extraDupInfo.textContent = '';
    }
    function renderLoading(){
      clearDupUI();
      statusBadge.className = 'badge badge--loading';
      statusBadge.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø«â€¦';
      amountText.textContent = 'â³';
      multiText.textContent = '';
      if (nameText) nameText.textContent = 'â€”';
    }
    function applyBadges(baseStatus, duplicateLabel, hasSalaries){
      let baseClass = 'badge--agent';
      if (baseStatus.includes('Ø§Ø¯Ø§Ø±Ø©') && !hasSalaries) baseClass = 'badge--admin';
      else if (baseStatus.includes('Ø³Ø­Ø¨ ÙˆÙƒØ§Ù„Ø©'))      baseClass = 'badge--withdraw';
      else if (baseStatus.includes('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'))      baseClass = 'badge--missing';
      statusBadge.className = 'badge ' + baseClass;
      statusBadge.textContent = baseStatus || 'â€”';
      if (duplicateLabel){ dupBadge.style.display='inline-block'; dupBadge.textContent=duplicateLabel; }
      else dupBadge.style.display='none';
    }
    function renderResult(res){
      lastResult = res;
      
      // Ø­Ø¯Ù‘Ø¯ Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ø¥Ù† ÙˆØ¬Ø¯ ÙÙ‰ Ø§Ù„Ù†ØªÙŠØ¬Ø© (Ø¥Ù…Ø§ Ø®Ø§ØµÙŠØ© name Ø£Ùˆ Ø¯Ù…Ø¬ Ù…ØµÙÙˆÙØ© names)
      (function(){ 
        try{
          let nm = '';
          if (res) {
            if (res.name) nm = String(res.name||'').trim();
            else if (Array.isArray(res.names)) nm = res.names.map(x=>String(x||'').trim()).filter(Boolean).join('ØŒ ');
          }
          if (nameText) nameText.textContent = nm || 'â€”';
        }catch(_){ if (nameText) nameText.textContent = 'â€”'; }
      })();
if (res.status === 'error'){ applyBadges('Ø®Ø·Ø£', null, false); amountText.textContent='â€”'; multiText.textContent=res.message||''; return; }
      if (res.status === 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'){ applyBadges('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', null, false); amountText.textContent='â€”'; multiText.textContent=''; return; }

      const baseStatus = res.status || '';
      const dupLabel   = (res.isDuplicate && res.duplicateLabel) ? res.duplicateLabel : null;

      const hasSalaries = Array.isArray(res.salaries) && res.salaries.length > 0;
      const isAdminOnly = baseStatus.includes('Ø§Ø¯Ø§Ø±Ø©') && !hasSalaries;

      applyBadges(baseStatus, dupLabel, hasSalaries);

      if (isAdminOnly){ amountText.textContent='â€”'; multiText.textContent=''; flash(resultsBox,'flash-blue'); return; }

      const total = Number(res.totalSalary)||0;
      const pct   = Math.max(0, Math.min(100, Number(discountInput.value)||0));
      amountText.textContent = fmt(total * (1 - pct/100));

      if (hasSalaries && res.salaries.length > 1){
        multiText.textContent = '(' + res.salaries.map(n=>fmt(Number(n)||0)).join(' + ') + ')';
      } else multiText.textContent = '';

      flash(resultsBox,'flash-blue');
    }

    /******** Ø§Ù„Ø±Ø³Ø§Ù„Ø© ********/
    function buildMessageText(card, applyDiscount, localMapRef){
      if (!card || !Array.isArray(card.ids)) return 'â€”';
      const pct = Math.max(0, Math.min(100, Number(discountInput.value)||0));
      const lm  = localMapRef || {};
      const header = [];
      if (card.name)    header.push(card.name);
      if (card.phone)   header.push(card.phone);
      if (card.address) header.push(card.address);
      if (card.agency)  header.push(card.agency);
      if (card.note)    header.push('Ù…Ù„Ø§Ø­Ø¸Ø© : ' + card.note);

      let total = 0;
      const idLines = [];
      card.ids.forEach(x=>{
        const id = String(x.id||'').trim();
        if (!id) return;
        const node = lm[id];
        const adminOnly = node ? (!node.rowsCount && node.inAdmin) : false;
        let val = Number(x.amount||0);
        if (applyDiscount) val = val * (pct ? (1 - pct/100) : 1);
        total += val;
        idLines.push({ id, text: `${id} ... ${fmt(val)}${adminOnly ? ' Ø§Ø¯Ø§Ø±Ø©' : ''}`, value: val });
      });

      const lines = [];
      lines.push(header.join('\n')); lines.push('');
      if (idLines.length === 1){
        lines.push(idLines[0].id); lines.push(''); lines.push(fmt(idLines[0].value));
      } else if (idLines.length > 1){
        lines.push(idLines.map(x=>x.text).join('\n'));
        lines.push('â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢');
        lines.push('Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ : ' + fmt(total));
        lines.push('â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢');
      }
      return lines.filter(Boolean).join('\n');
    }

    function renderPersonCard(id){
      if (isPersonFeatureDisabled()) { personNote.textContent='â€”'; personMsg.value=''; return; }
      personNote.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©...';
      personMsg.value = '';
      lastProfileIds = [];
      google.script.run
        .withSuccessHandler(card=>{
          if(!card || !card.ok){
            personNote.textContent = card?.message || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª.';
            personMsg.value = '';
            return;
          }
          lastProfileIds = (card.ids||[]).map(x=> String(x.id));
          const txt = buildMessageText(card, applyDiscountToMessage.checked, localMap);
          personMsg.value = txt;
          personNote.textContent = `ØªÙ… â€” Ø¹Ø¯Ø¯ IDs: ${lastProfileIds.length}`;
          flash(personCardEl, 'flash-blue');

          clearDupUI();
          const dupList = [];
          lastProfileIds.forEach(uid=>{
            const node = localMap && localMap[uid];
            if (!node) return;
            if (node.aCol && node.dCol) dupList.push(`${uid} (Ù…ÙƒØ±Ø±)`);
            else if (node.aCol)         dupList.push(`${uid} (Ù…ÙƒØ±Ø± ÙˆÙƒØ§Ù„Ø© ÙÙ‚Ø·)`);
            else if (node.dCol)         dupList.push(`${uid} (Ù…ÙƒØ±Ø± Ø§Ø¯Ø§Ø±Ø© ÙÙ‚Ø·)`);
          });
          if (dupList.length){
            dupBadge.style.display='inline-block';
            dupBadge.textContent='Ù…ÙƒØ±Ø±';
            extraDupInfo.textContent = 'IDs Ù…ÙƒØ±Ø±Ø©: ' + dupList.join('ØŒ ');
          }
        })
        .withFailureHandler(err=>{
          personNote.textContent = 'Ø®Ø·Ø£: ' + (err?.message||'');
          personMsg.value = '';
        })
        .getPersonCardById(id);
    }

    function rebuildPersonCardUsingLast(){
      if (isPersonFeatureDisabled()) return;
      if (lastBaseId){
        google.script.run
          .withSuccessHandler(card=>{
            if(card && card.ok){
              personMsg.value = buildMessageText(card, !!applyDiscountToMessage.checked, localMap);
              personNote.textContent = `ØªÙ… â€” Ø¹Ø¯Ø¯ IDs: ${(card.ids||[]).length}`;
            }
          })
          .getPersonCardById(lastBaseId);
      }
    }

    copyMsgBtn.addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(personMsg.value||'');
        copyMsgBtn.textContent = 'âœ“ Ù†ÙØ³Ø®Øª';
        setTimeout(()=> copyMsgBtn.textContent='Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 900);
      }catch(_){
        personMsg.select(); document.execCommand('copy');
      }
    });

    colorAllBtn.addEventListener('click', ()=>{
      if (isPersonFeatureDisabled()) { personNote.textContent='Ø§Ù„Ù…ÙŠØ²Ø© Ù…Ø¹Ø·Ù‘Ù„Ø©.'; return; }
      if (!lastProfileIds.length){ personNote.textContent='Ù„Ø§ IDs Ù„ØªÙ„ÙˆÙŠÙ†Ù‡Ø§.'; return; }
      const sheet = sheetSelect.value;
      const targetMode = targetModeSel.value;
      if (targetMode==='both' && !sheet){ advNote.textContent='Ø§Ø®ØªØ± ÙˆØ±Ù‚Ø© Ø§Ù„Ù‡Ø¯Ù Ø£ÙˆÙ„Ø§Ù‹.'; return; }

      personNote.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ„ÙˆÙŠÙ†...';
      let done=0, fail=0;
      const runOne = (uid)=> new Promise((resolve)=>{
        google.script.run
          .withSuccessHandler(_=>{ done++; resolve(true); })
          .withFailureHandler(_=>{ fail++; resolve(false); })
          .applyAdvancedAction(uid, sheet, adminColor.value, withdrawColor.value, targetMode);
      });
      Promise.all(lastProfileIds.map(runOne)).then(()=>{
        personNote.textContent = `ØªÙ… â€” Ù…Ù„ÙˆÙ‘Ù†: ${done}, ÙØ´Ù„: ${fail}`;
        flash(personCardEl,'flash-green');
        if(localMap){
          lastProfileIds.forEach(uid=>{
            if(!localMap[uid]) return;
            localMap[uid].aCol = true;
            if (targetMode==='both') localMap[uid].dCol = true;
          });
        }
        refreshCountsLive();
      });
    });

    /******** ØªÙ†ÙÙŠØ° Ø°ÙƒÙŠ ********/
    function runAdvanced() {
      advNote.textContent = '... Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ†ÙÙŠØ°';
      const id = idInput.value.trim();
      if (!id) { advNote.textContent = 'âš ï¸ Ø£Ø¯Ø®Ù„ ID Ø£ÙˆÙ„Ø§Ù‹'; return; }

      const sheet = sheetSelect.value;
      const targetMode = targetModeSel.value;
      if (targetMode === 'both' && !sheet) {
        advNote.textContent = 'âš ï¸ Ø§Ø®ØªØ± ÙˆØ±Ù‚Ø© Ø§Ù„Ù‡Ø¯Ù';
        return;
      }

      google.script.run
        .withSuccessHandler(res => {
          advNote.textContent = res?.message || 'ØªÙ… âœ…';
          flash(advCard, 'flash-green');
          if (localMap && localMap[id]) {
            localMap[id].aCol = true;
            if (targetMode === 'both') localMap[id].dCol = true;
          }
          if (lastResult) renderResult(lastResult);
          refreshCountsLive();
        })
        .withFailureHandler(err => {
          advNote.textContent = 'Ø®Ø·Ø£: ' + (err?.message || '');
        })
        .applyAdvancedAction(id, sheet, adminColor.value, withdrawColor.value, targetMode);
    }
    advRunBtn.addEventListener('click', runAdvanced);

    /******** Ø¹Ø¯Ø§Ø¯ / ÙˆØ¶Ø¹ Ø¯Ø§ÙƒÙ† / Ø¥Ø®ÙØ§Ø¡ ØªØ­Ù…ÙŠÙ„ ********/
    function fmtNum(n){ const x=Number(n); return isNaN(x)?'â€”':new Intl.NumberFormat('en-US').format(x); }
    function refreshCountsLive(pctOverride){
      const pct = (typeof pctOverride === 'number') ? pctOverride : Number(discountInput?.value || 0);
      google.script.run
        .withSuccessHandler(res=>{
          if(!res || !res.ok){ qtColored.textContent='â€”'; qtUncolored.textContent='â€”'; return; }
          qtColored.textContent   = fmtNum(res.coloredRows || 0);
          qtUncolored.textContent = fmtNum(res.uncoloredRows || 0);
        })
        .withFailureHandler(()=>{ qtColored.textContent='â€”'; qtUncolored.textContent='â€”'; })
        .getLiveStatsForFooter(pct);
    }
    function applyModeLabel(){
      const isDark = document.body.classList.contains('dark');
      qtMode.textContent = isDark ? 'â˜€ï¸ ÙˆØ¶Ø¹ ÙØ§ØªØ­' : 'ğŸŒ™ ÙˆØ¶Ø¹ Ø¯Ø§ÙƒÙ†';
    }
    try { if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark'); } catch(_){}
    applyModeLabel();
    qtMode.addEventListener('click', ()=>{
      const isDark = document.body.classList.toggle('dark');
      applyModeLabel();
      try { localStorage.setItem('darkMode', isDark ? 'true':'false'); } catch(_){}
    });
    function applyHideState(){
      const loadCard = document.getElementById('loadCard');
      const hide = (localStorage.getItem('hide_loadsec') === '1');
      if (loadCard) loadCard.style.display = hide ? 'none' : '';
      qtHide.textContent = hide ? 'ğŸ‘€ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„' : 'ğŸ™ˆ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
    }
    applyHideState();
    qtHide.addEventListener('click', ()=>{
      const cur = localStorage.getItem('hide_loadsec') === '1';
      localStorage.setItem('hide_loadsec', cur ? '0':'1');
      applyHideState();
    });
    document.getElementById('qtRefreshCnt').addEventListener('click', refreshCountsLive);

    /******** Ø§Ù„Ø¨Ø­Ø« (Ù…Ø­Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ø³ÙŠØ±ÙØ±) ********/
    let querySeq = 0;
    function normalizeId(v){ return String(v||'').trim(); }

    function buildLocalResult(id){
      if (!localMap || (!localMap[id] && !Object.prototype.hasOwnProperty.call(localMap, id))) {
        // Ù„Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙˆÙƒÙŠÙ„ØŒ ÙŠÙ…ÙƒÙ† ÙŠÙƒÙˆÙ† "Ø§Ø¯Ø§Ø±Ø© ÙÙ‚Ø·" â€” Ù†ØªØ±Ùƒ Ù„Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø­ÙƒÙ…
        return { status:'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', totalSalary:'0.00', salaries:[], id:id, isDuplicate:false };
      }
      const node = localMap[id] || {};
      const inAdmin = !!node.inAdmin;
      const rowsCount = Number(node.rowsCount||0);
      const total = Number(node.sum||0);
      const salaries = Array.isArray(node.salaries) ? node.salaries.map(Number) : [];

      let status = 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
      if (rowsCount > 0) {
        status = inAdmin ? ((rowsCount>1)? 'Ø³Ø­Ø¨ ÙˆÙƒØ§Ù„Ø© - Ø±Ø§ØªØ¨ÙŠÙ†':'Ø³Ø­Ø¨ ÙˆÙƒØ§Ù„Ø©') : ((rowsCount>1)? 'Ø±Ø§ØªØ¨ÙŠÙ†':'ÙˆÙƒØ§Ù„Ø©');
      } else if (inAdmin) {
        status = 'Ø§Ø¯Ø§Ø±Ø©';
      }

      // Ù…ÙƒØ±Ø±ØŸ
      let isDuplicate=false, duplicateLabel=null;
      const aCol = !!node.aCol;
      const dCol = !!node.dCol;
      if (aCol && dCol) { isDuplicate = true; duplicateLabel = 'Ù…ÙƒØ±Ø±'; }
      else if (aCol)    { isDuplicate = true; duplicateLabel = 'Ù…ÙƒØ±Ø± ÙˆÙƒØ§Ù„Ø© ÙÙ‚Ø·'; }
      else if (dCol)    { isDuplicate = true; duplicateLabel = 'Ù…ÙƒØ±Ø± Ø§Ø¯Ø§Ø±Ø© ÙÙ‚Ø·'; }

      return {
        status: status,
        totalSalary: total.toFixed(2),
        salaries: salaries,
        discountAmount: '0.00',
        salaryAfterDiscount: total.toFixed(2),
        id: id,
        isDuplicate: isDuplicate,
        duplicateLabel: duplicateLabel
      };
    }

    function doSearch(){
  const id = String(idInput.value||'').trim();
  if (!id){
    applyBadges('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', null, false);
    amountText.textContent = 'â€”';
    multiText.textContent  = '';
    personNote.textContent = 'â€”';
    personMsg.value = '';
    clearDupUI();
    return;
  }

  saveLastId(id);
  lastBaseId = id;
  renderLoading(); // Ø£Ø¨Ù‚Ù "Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø«â€¦" ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ

  const hasLocal = !!(localMap && Object.prototype.hasOwnProperty.call(localMap, id));
  if (hasLocal){
    // Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙˆÙƒÙŠÙ„: Ø£Ø¹Ø±Ø¶ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙˆØ±Ù‹Ø§ (ÙˆÙƒØ§Ù„Ø©/Ø³Ø­Ø¨ ÙˆÙƒØ§Ù„Ø©/Ø±Ø§ØªØ¨ÙŠÙ†)
    const node = localMap[id];
    const inAdmin   = !!node.inAdmin;
    const rowsCount = Number(node.rowsCount||0);
    const total     = Number(node.sum||0);
    const salaries  = Array.isArray(node.salaries) ? node.salaries.map(Number) : [];
    let status;
    if (rowsCount > 0) status = inAdmin ? ((rowsCount>1)? 'Ø³Ø­Ø¨ ÙˆÙƒØ§Ù„Ø© - Ø±Ø§ØªØ¨ÙŠÙ†':'Ø³Ø­Ø¨ ÙˆÙƒØ§Ù„Ø©')
                                        : ((rowsCount>1)? 'Ø±Ø§ØªØ¨ÙŠÙ†':'ÙˆÙƒØ§Ù„Ø©');
    else status = 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';

    let isDuplicate=false, duplicateLabel=null;
    if (node.aCol && node.dCol) { isDuplicate = true; duplicateLabel = 'Ù…ÙƒØ±Ø±'; }
    else if (node.aCol)         { isDuplicate = true; duplicateLabel = 'Ù…ÙƒØ±Ø± ÙˆÙƒØ§Ù„Ø© ÙÙ‚Ø·'; }
    else if (node.dCol)         { isDuplicate = true; duplicateLabel = 'Ù…ÙƒØ±Ø± Ø§Ø¯Ø§Ø±Ø© ÙÙ‚Ø·'; }

    renderResult({
      status,
      totalSalary: total.toFixed(2),
      salaries,
      names: (Array.isArray(node.names) ? node.names : []),
      name: (Array.isArray(node.names) && node.names.length ? String(node.names[0]||'').trim() : ''),
      discountAmount: '0.00',
      salaryAfterDiscount: total.toFixed(2),
      id,
      isDuplicate,
      duplicateLabel
    });
  }
  // Ø¥Ø°Ø§ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø­Ù„ÙŠÙ‹Ø§ (Ù‚Ø¯ ÙŠÙƒÙˆÙ† "Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø·"): Ù„Ø§ Ù†Ø¹Ø±Ø¶ "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" â€” Ù†Ù†ØªØ¸Ø± Ø±Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ±.

  const mySeq = (++window.__qseq || (window.__qseq=1));
  const pct = Number(discountInput?.value || 0);

  google.script.run
    .withSuccessHandler(res=>{
      if (mySeq !== window.__qseq) return; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©
      if (!res || res.status === 'error'){
        if (res && res.message) renderResult({ status:'error', message: res.message });
        return;
      }
      renderResult(res);
      renderPersonCard(id);
    })
    .withFailureHandler(err=>{
      if (err && err.message) renderResult({ status:'error', message: err.message });
    })
    .searchId(id, pct);
}

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®ØµÙ… Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„Ø§Øª
    (function(){
      if (!discountInput) return;
      let t;
      discountInput.addEventListener('input', ()=>{
        if (t) clearTimeout(t);
        t = setTimeout(()=>{
          if (lastResult) renderResult(lastResult);
          const pct = Math.max(0, Math.min(100, Number(discountInput.value)||0));
          refreshCountsLive(pct);
          if (applyDiscountToMessage?.checked && lastBaseId) rebuildPersonCardUsingLast();
        }, 120);
      });
    })();

    // Ù…Ù‡ÙŠÙ‘Ø¦ Ø³ÙˆÙŠØªØ´ "ØªØµØ­ÙŠØ­ Ø§Ù„Ø±Ø§ØªØ¨"
    function initSalaryCorrectionSwitch(){
      if (!enableSalaryCorrection) return;
      google.script.run
        .withSuccessHandler(res=>{
          try { enableSalaryCorrection.checked = !!(res && res.enabled); } catch(_){}
        })
        .withFailureHandler(()=>{})
        .getSalaryCorrectionEnabled();

      enableSalaryCorrection.addEventListener('change', ()=>{
        const desired = !!enableSalaryCorrection.checked;
        google.script.run
          .withSuccessHandler(res=>{
            if (!res || typeof res.enabled === 'undefined') return;
            if (!!res.enabled !== desired) enableSalaryCorrection.checked = !!res.enabled;
            if (lastBaseId) rebuildPersonCardUsingLast();
          })
          .withFailureHandler(()=>{ enableSalaryCorrection.checked = !desired; })
          .setSalaryCorrectionEnabled(desired ? 1 : 0);
      });
    }

    // Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„
    window.addEventListener('load', ()=>{
      applyPersonVisibility();
      loadLastId();
      loadData();
      fillSheets();
      initSalaryCorrectionSwitch();
      setTimeout(refreshCountsLive, 600);
    });
  </script>
  <style>
@media (max-width: 1059px){
  #quickTools{
    grid-column: 1 / -1;
    grid-row: 999;
    margin-top: 12px;
  }
}
</style>
<script>
(function(){
  function placeQT(){
    var qt = document.getElementById('quickTools');
    var cont = document.querySelector('.container');
    if(!qt || !cont) return;
    var w = Math.min(window.innerWidth, document.documentElement.clientWidth || window.innerWidth);
    if (w <= 1059) cont.appendChild(qt);
  }
  window.addEventListener('load', placeQT);
  window.addEventListener('resize', function(){
    clearTimeout(window.__qt_fix);
    window.__qt_fix = setTimeout(placeQT, 150);
  });
})();
</script>
<style>
/* ØªØ­Ø³ÙŠÙ† ØªÙ†Ø³ÙŠÙ‚ Ù‚Ø³Ù… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
@media (max-width: 640px){
  /* Ø®Ù„ÙŠ ØµÙÙˆÙ Ø§Ù„Ù‚Ø³Ù… Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‘Ù */
  #advCard .row{ flex-wrap: wrap !important; }

  /* ØµÙ (Ø§Ù„Ù‡Ø¯Ù + Ø§Ù„ØªÙ†ÙÙŠØ° + ØªØ­Ø¯ÙŠØ«) */
  #advCard .row:first-of-type label.small{
    width: 100% !important;
    min-width: 0 !important;
    display: block;
    margin: 0 0 6px 0 !important;
    font-size: 12px;
    opacity: .9;
  }
  #advCard #sheetSelect,
  #advCard #targetMode{
    flex: 1 1 100% !important;
    width: 100% !important;
    min-width: 0 !important;
    height: 40px;
  }
  #advCard #refreshSheetsBtn{
    order: 3;                /* Ù†Ø²Ù‘Ù„Ù‡ ØªØ­Øª Ø§Ù„Ø­Ù‚ÙˆÙ„ */
    width: 100%;
    margin-top: 6px;
  }

  /* ØµÙ Ø§Ù„Ø£Ù„ÙˆØ§Ù† (Ù„ÙˆÙ† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© / Ø³Ø­Ø¨ ÙˆÙƒØ§Ù„Ø©) */
  #advCard .row[style*="flex-wrap:wrap"] > div{
    flex: 1 1 100% !important;
  }
  #advCard input[type="color"]{
    width: 40px !important;
    height: 34px !important;
  }

  /* ØµÙ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø© */
  #advCard #newSheetName{
    flex: 1 1 100% !important;
    width: 100% !important;
  }
  #advCard #createSheetBtn{
    flex: 0 0 100% !important;
    width: 100% !important;
    margin-top: 6px;
  }

  /* ØµÙ Ø§Ù„Ø®ØµÙ… + Ø§Ù„Ø³ÙˆÙŠØªØ´Ø§Øª */
  #advCard input[type="number"]{
    width: 100% !important;
    flex: 1 1 100% !important;
    height: 40px;
  }
  #advCard .toggle-chip{
    flex: 1 1 48% !important;
    justify-content: space-between;
    margin-top: 6px;
  }

  /* Ø²Ø± Ø§Ù„ØªÙ†ÙÙŠØ°: Ù…Ù‡Ùˆ ÙƒØ§Ù…Ù„ Ø£ØµÙ„Ø§Ù‹ØŒ Ù†Ø²ÙˆØ¯ Ø±Ø§Ø­Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
  #advCard #advRunBtn{
    padding: 14px 16px !important;
    font-size: 16px !important;
    border-radius: 12px !important;
  }

  /* Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙ†ÙÙŠØ° ÙŠØ¸Ù‡Ø± ÙˆØ§Ø¶Ø­ ÙˆØªØ­Øª Ø§Ù„Ø²Ø± */
  #advCard #advNote{ font-size: 12px; line-height: 1.4; }
}
</style>

<script>
/* ØªØ±ØªÙŠØ¨ Ø¨Ø³ÙŠØ·: Ø¶Ù…Ù† Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ØŒ Ø­Ø· Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø§Ø¦Ù…ØªÙŠÙ† Ø¯Ø§Ø¦Ù…Ø§Ù‹ */
(function(){
  function fixAdvLayout(){
    var w = Math.min(window.innerWidth, document.documentElement.clientWidth||window.innerWidth);
    if (w > 640) return;
    var row = document.querySelector('#advCard .row');
    var btn = document.getElementById('refreshSheetsBtn');
    if(row && btn) row.appendChild(btn);
  }
  window.addEventListener('load', fixAdvLayout);
  window.addEventListener('resize', function(){ clearTimeout(window.__advFix); window.__advFix=setTimeout(fixAdvLayout,150); });
})();
</script>
<!-- ===== /Bulk IDs â€” Advanced ===== -->
<!-- Ø´Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª (ÙØ­Øµ Ø°ÙƒÙŠØŒ Ù„Ø§ ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙ†ÙÙŠØ° Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø·Ø¡) -->
<style>
  #netBadge{position:fixed;inset-inline-end:12px;inset-block-end:12px;z-index:9999;padding:6px 10px;border-radius:10px;font-size:12px;font-weight:700;box-shadow:0 4px 12px rgba(0,0,0,.15);background:#e5fbe5;border:1px solid #c6f6c6;color:#0b1020;display:flex;align-items:center;gap:6px}
  #netBadge.net-weak{background:#fff8e5;border-color:#ffe7a8;color:#6b4e00}
  #netBadge.net-down{background:#ffe5e5;border-color:#ffc2c2;color:#6b0000}
  #netBadge .dot{width:8px;height:8px;border-radius:50%;background:#16a34a}
  #netBadge.net-weak .dot{background:#f59e0b}
  #netBadge.net-down .dot{background:#ef4444}
</style>
<div id="netBadge"><span class="dot"></span><span id="netText">ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„â€¦</span></div>

<script>
(function(){
  const badge=document.getElementById('netBadge');
  const text=document.getElementById('netText');

  function setState(kind,label){
    badge.classList.remove('net-weak','net-down');
    if(kind==='ok'){ text.textContent=`Ù…ØªØµÙ„ âœ… ${label||''}`.trim(); }
    else if(kind==='weak'){ badge.classList.add('net-weak'); text.textContent=`Ø¨Ø·ÙŠØ¡ ğŸŸ¡ ${label||''}`.trim(); }
    else { badge.classList.add('net-down'); text.textContent=`Ø£ÙˆÙÙ„Ø§ÙŠÙ† â›” ${label||''}`.trim(); }
  }

  function pingServer(timeoutMs){
    return new Promise(res=>{
      let done=false, t0=performance.now();
      try{
        google.script.run
          .withSuccessHandler(()=>{ if(done) return; done=true; res({ok:true,rtt:performance.now()-t0}); })
          .withFailureHandler(()=>{ if(done) return; done=true; res({ok:false}); })
          .ping?.();
        setTimeout(()=>{ if(done) return; done=true; res({ok:false}); }, timeoutMs||2000);
      }catch(_){ res({ok:false}); }
    });
  }

  let lastPing=0;
  async function checkNow(){
    // ÙØ­Øµ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© (Ø³Ù†ÙØ¹Ù‘Ù„Ù‡ Ø¨Ø§Ù„interval Ø¨Ø§Ù„Ø£Ø³ÙÙ„)
    if(!navigator.onLine){ setState('down','(Ø§Ù„Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…ØªØµÙ„)'); window.__serverReachable=false; return; }

    // ÙØ­Øµ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© ÙÙ‚Ø·
    const now=Date.now();
    if(now-lastPing>30000){
      lastPing=now;
      const s=await pingServer(1500);
      if(s.ok){
        const rtt=Math.round(s.rtt||0);
        if(rtt<=700) setState('ok',`(${rtt}ms)`); else setState('weak',`(${rtt}ms)`);
        window.__serverReachable=true;   // Ù†Ø³ØªÙÙŠØ¯ Ù…Ù†Ù‡Ø§ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
      }else{
        setState('weak','()'); // Ø¹Ø±Ø¶ ÙÙ‚Ø·Ø› Ù…Ø§ ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙ†ÙÙŠØ°
        window.__serverReachable=false;
      }
    }
  }

  // ÙØ­Øµ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© + Ø§Ù„Ø³ÙŠØ±ÙØ± ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
  setInterval(checkNow,1000);
  checkNow();
  window.addEventListener('online',()=>{ lastPing=0; checkNow(); });
  window.addEventListener('offline',()=> setState('down','(Ø§Ù„Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…ØªØµÙ„)'));

  // ğŸ” Ø£Ù‡Ù… ØªØºÙŠÙŠØ±: Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ†ÙÙŠØ° Ù…Ø§ Ø¯Ø§Ù… Ø§Ù„Ø¬Ù‡Ø§Ø² Online Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø·ÙŠØ¡
  window.netEnsureOnline = async function(){
    // Ù„Ùˆ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø£ÙˆÙÙ„Ø§ÙŠÙ† ÙÙ‚Ø· Ù†Ù…Ù†Ø¹
    if(!navigator.onLine){
      alert('â›” Ø§Ù„Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
      return false;
    }
    // Ø®Ù„Ø§Ù Ø°Ù„Ùƒ Ù†Ø³Ù…Ø­ Ø¯ÙˆÙ…Ù‹Ø§ (Ø³Ø±ÙŠØ¹ Ø£Ùˆ Ø¨Ø·ÙŠØ¡ / Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØªØ£Ø®Ø± Ø¨Ø§Ù„Ø±Ø¯)
    return true;
  };
})();
</script>
<script>
/* Ø­Ø§Ø±Ø³ Ø²Ø± Ø§Ù„ØªÙ†ÙÙŠØ° â€” ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙ†ÙÙŠØ° Ù„Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ ØºÙŠØ± Ø¬Ø§Ù‡Ø² (Ø¨Ø¯ÙˆÙ† Ù„Ù…Ø³ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ) */
(function guardExecButton(){
  const SELECTORS = ['#advRunBtn']; // Ø£Ø¶Ù Ø£Ø²Ø±Ø§Ø± Ø£Ø®Ø±Ù‰ Ù‡Ù†Ø§ Ù„Ùˆ ØªØ­Ø¨

  function isServerLikelyUp(){
    if (window.__serverReachable === true)  return true;
    if (window.__serverReachable === false) return false;
    return navigator.onLine; // ØªÙ‚Ø¯ÙŠØ± Ø³Ø±ÙŠØ¹
  }

  async function ensureOnlineInteractive(){
    if (typeof window.netEnsureOnline === 'function'){
      return await window.netEnsureOnline();
    }
    if (!navigator.onLine){ alert('â›” Ø§Ù„Ø¬Ù‡Ø§Ø² Ø£ÙˆÙÙ„Ø§ÙŠÙ† â€” Ù„Ù† ÙŠØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°.'); return false; }
    if (window.__serverReachable === false){ alert('ğŸŸ¡ Ø§Ù„Ø³ÙŠØ±ÙØ± ØºÙŠØ± Ù…ØªØ§Ø­ â€” Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ Ø­Ø¯Ù‘Ø« Ø§Ù„ØµÙØ­Ø©.'); return false; }
    return true;
    }

  function handlerCapture(e){
    const btn = e.target.closest(SELECTORS.join(','));
    if (!btn) return;
    e.preventDefault();
    e.stopImmediatePropagation();

    (async ()=>{
      if (!isServerLikelyUp()){
        const ok = await ensureOnlineInteractive();
        if (!ok) return;
      } else {
        const ok = await ensureOnlineInteractive();
        if (!ok) return;
      }
      // Ù…Ø±Ù‘Øª Ø§Ù„Ø´Ø±ÙˆØ· âœ… â€” Ø£Ø¹Ø¯ Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ù‚Ø± Ù„ÙŠÙƒÙ…Ù„ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ
      document.removeEventListener('click', handlerCapture, true);
      try { btn.click(); } finally {
        setTimeout(()=> document.addEventListener('click', handlerCapture, true), 0);
      }
    })();
  }

  document.addEventListener('click', handlerCapture, true);
})();
</script>
<!-- ======= Ø³Ø¬Ù„ Ø§Ù„Ù†Ù‚Ù„ â€” ÙˆØ§Ø¬Ù‡Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© ======= -->
<style>
  .lgp-btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:12px 14px;border:1px solid #16a34a;background:#22c55e;color:#fff;
    font-weight:800;cursor:pointer;width:100%;margin:10px 0;border-radius:12px}
  .lgp-btn:disabled{opacity:.6;cursor:not-allowed}

  .lgp-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
    background:rgba(0,0,0,.35);z-index:99999}
  .lgp-modal.show{display:flex}
  .lgp-sheet{width:min(92vw,560px);padding:14px;background:var(--card-bg,#111827);color:var(--fg,#e5e7eb);
    box-shadow:0 12px 28px rgba(0,0,0,.25);border:1px solid var(--border,#374151);border-radius:12px;overflow:hidden}
  .lgp-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .lgp-title h3{margin:0;font-size:16px;font-weight:800}
  .lgp-ghost{border:1px solid var(--border,#374151);background:transparent;padding:8px 12px;color:inherit;border-radius:12px}

  .lgp-list{max-height:56vh;overflow:auto;border:1px solid var(--border,#374151);background:rgba(255,255,255,.02);border-radius:12px}
  .lgp-row{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:10px;border-bottom:1px solid var(--border,#374151)}
  .lgp-row:last-child{border-bottom:0}
  .lgp-id{font-family:ui-monospace,monospace;font-weight:800}
  .lgp-meta{font-size:11px;opacity:.8}

  .lgp-controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .lgp-select,.lgp-color{border:1px solid var(--border,#374151);background:transparent;color:inherit;padding:10px;border-radius:12px}
  .lgp-primary{background:#22c55e;border:1px solid #16a34a;color:#fff;padding:12px;font-weight:800;border-radius:12px}

  .lgp-toggle{display:inline-flex;align-items:center;gap:10px}
  .ios-switch{position:relative;width:48px;height:28px}
  .ios-switch input{appearance:none;-webkit-appearance:none;width:48px;height:28px;margin:0;cursor:pointer}
  .ios-switch .track{position:absolute;inset:0;background:#6b7280;transition:.2s;border-radius:999px}
  .ios-switch .thumb{position:absolute;top:3px;left:3px;width:22px;height:22px;background:#fff;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.25);transition:.2s}
  .ios-switch input:checked ~ .track{ background:#22c55e }
  .ios-switch input:checked ~ .thumb{ left:23px }

  .lgp-color{ width:44px;height:34px;padding:0 }
  .lgp-hint{font-size:12px;opacity:.75;margin-top:6px}
</style>

<!-- Ø²Ø± "Ø§Ù„Ø³Ø¬Ù„" (ÙŠÙØ²Ø±ÙØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ØªØ­Øª Ø²Ø± Ø§Ù„ØªÙ†ÙÙŠØ°) -->
<div id="lgpMount" style="display:none">
  <button id="lgpOpen" class="lgp-btn">ğŸ“ Ø§Ù„Ø³Ø¬Ù„</button>
</div>

<!-- Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
<div id="lgpModal" class="lgp-modal" role="dialog" aria-modal="true">
  <div class="lgp-sheet">
    <div class="lgp-title">
      <h3>ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ù†Ù‚Ù„ (Ø¢Ø®Ø± 15)</h3>
      <button id="lgpClose" class="lgp-ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div id="lgpList" class="lgp-list">
      <div class="lgp-row"><div></div><div>â€¦ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„</div><div></div></div>
    </div>

    <div class="lgp-controls">
      <select id="lgpTarget" class="lgp-select" title="Ø§Ø®ØªØ± ÙˆØ±Ù‚Ø© Ø§Ù„Ù‡Ø¯Ù">
        <option>â€¦ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>
      </select>

      <div class="lgp-toggle">
        <span style="font-size:12px;opacity:.8">Ù„ÙˆÙ† Ù…Ø®ØµÙ‘Øµ</span>
        <label class="ios-switch">
          <input id="lgpUseCustom" type="checkbox">
          <span class="track"></span><span class="thumb"></span>
        </label>
      </div>
      <input id="lgpColor" type="color" class="lgp-color" value="#ddd6fe" title="Ù„ÙˆÙ† Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ù‚Ù„" disabled>

      <button id="lgpMove" class="lgp-primary">Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
    </div>

    <div id="lgpHint" class="lgp-hint"></div>
  </div>
</div>

<script>
/* Ø²Ø±Ø¹ Ø²Ø± Ø§Ù„Ø³Ø¬Ù„ ØªØ­Øª Ø²Ø± ØªÙ†ÙÙŠØ° (Ø­Ø³Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©) */
(function(){
  var mount = document.getElementById('lgpMount');
  function placeButton(){
    var host=null, runBtn=document.getElementById('advRunBtn');
    if(runBtn) host=runBtn.closest('.card');
    if(!host) host=document.getElementById('advCard');
    if(!host){ var cards=document.querySelectorAll('.card'); if(cards.length) host=cards[cards.length-1]; }
    if(!host) host=document.body;
    if(mount.parentNode!==host) host.appendChild(mount);
    mount.style.display='block';
  }
  function ensureMounted(){
    placeButton();
    setTimeout(placeButton,150); setTimeout(placeButton,400); setTimeout(placeButton,1000);
    window.addEventListener('resize',()=>setTimeout(placeButton,150));
    new MutationObserver(()=>placeButton()).observe(document.body,{childList:true,subtree:true});
  }
  (document.readyState==='loading') ? document.addEventListener('DOMContentLoaded',ensureMounted) : ensureMounted();
})();

/* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø¬Ù„ */
(function(){
  var modal=document.getElementById('lgpModal');
  var openBtn=document.getElementById('lgpOpen');
  var closeBtn=document.getElementById('lgpClose');
  var list=document.getElementById('lgpList');
  var sel=document.getElementById('lgpTarget');
  var useCustom=document.getElementById('lgpUseCustom');
  var colorInp=document.getElementById('lgpColor');
  var move=document.getElementById('lgpMove');
  var hint=document.getElementById('lgpHint');

  function setHint(msg){ if(hint) hint.textContent = msg || ''; }

  function renderList(items){
    list.innerHTML='';
    if(!items||!items.length){
      list.innerHTML='<div class="lgp-row"><div></div><div>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„</div><div></div></div>';
      list.__rows__=[];
      return;
    }
    items.forEach(function(it,i){
      var row=document.createElement('div');
      row.className='lgp-row';
      row.innerHTML = `
        <label><input type="checkbox" data-idx="${i}"></label>
        <div>
          <div class="lgp-id">${it.id||'â€”'} | ${it.target||'â€”'}</div>
          <div class="lgp-meta">${it.at||''} â€¢ ØµÙÙˆÙ: ${it.rows||1}</div>
        </div>
        <div style="width:18px;height:18px;border:1px solid var(--border,#374151);border-radius:6px;background:${it.color||'transparent'}"></div>
      `;
      list.appendChild(row);
    });
    list.__rows__ = items || [];
  }

  function loadAll(){
    list.innerHTML='<div class="lgp-row"><div></div><div>â€¦ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„</div><div></div></div>';
    sel.innerHTML='<option>â€¦ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>';
    setHint('ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø£ÙˆØ±Ø§Ù‚â€¦');

    // Ø§Ù„Ø³Ø¬Ù„
    google.script.run
      .withSuccessHandler(function(items){ renderList(items||[]); setHint(''); })
      .withFailureHandler(function(err){
        list.innerHTML='<div class="lgp-row"><div></div><div>âš ï¸ Ø®Ø·Ø£ getMoveLogLatest: '+(err&&err.message||'')+'</div><div></div></div>';
        list.__rows__=[];
        setHint('');
      })
      .getMoveLogLatest(15);

    // Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ (ÙŠØ³ØªØ®Ø¯Ù… getAdminSheetsSafeØŒ ÙˆØ¥Ù† ÙØ´Ù„ ÙŠØ­Ø§ÙˆÙ„ getAdminSheets)
    google.script.run
      .withSuccessHandler(function(arr){
        sel.innerHTML='';
        (arr||[]).forEach(function(n){
          var o=document.createElement('option'); o.value=o.textContent=n; sel.appendChild(o);
        });
        var sheetSelect=document.getElementById('sheetSelect');
        if(sheetSelect && sheetSelect.value) sel.value = sheetSelect.value;
      })
      .withFailureHandler(function(){
        google.script.run
          .withSuccessHandler(function(arr){
            sel.innerHTML='';
            (arr||[]).forEach(function(n){
              var o=document.createElement('option'); o.value=o.textContent=n; sel.appendChild(o);
            });
          })
          .withFailureHandler(function(err){
            sel.innerHTML=''; var o=document.createElement('option');
            o.textContent='âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚: '+(err&&err.message||''); sel.appendChild(o);
          })
          .getAdminSheets();
      })
      .getAdminSheetsSafe();
  }

  // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚
  openBtn && openBtn.addEventListener('click', ()=>{ loadAll(); modal.classList.add('show'); });
  closeBtn && closeBtn.addEventListener('click', ()=> modal.classList.remove('show'));
  modal.addEventListener('click', e=>{ if(e.target===modal) modal.classList.remove('show'); });

  // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ù„ÙˆÙ† Ù…Ø®ØµØµ
  function syncColor(){ colorInp.disabled = !useCustom.checked; colorInp.style.opacity = useCustom.checked ? '1' : '.55'; }
  useCustom && useCustom.addEventListener('change', syncColor); syncColor();

  // Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯
  move && move.addEventListener('click', function(){
    var checks = Array.from(list.querySelectorAll('input[type=checkbox]:checked'));
    if(!checks.length){ alert('Ø§Ø®ØªØ± Ø¹Ù†Ø§ØµØ± Ù„Ù„Ù†Ù‚Ù„'); return; }
    var rows = list.__rows__ || [];
    var pick = checks.map(function(ch){ var r=rows[+ch.dataset.idx]||{}; return { id:(r.id||''), from:(r.target||'') }; });
    var override = useCustom && useCustom.checked ? (colorInp.value||'') : '';

    move.disabled=true; move.textContent='Ø¬Ø§Ø±Ù Ø§Ù„Ù†Ù‚Ù„â€¦';
    google.script.run
      .withSuccessHandler(function(res){
        move.disabled=false; move.textContent='Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯';
        alert(res && res.message ? res.message : 'ØªÙ….');
        loadAll();
      })
      .withFailureHandler(function(err){
        move.disabled=false; move.textContent='Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯';
        alert('Ø®Ø·Ø£: '+(err&&err.message||'')); 
      })
      .moveFromLog(pick, sel.value||'', override);
  });
})();
</script>
<?!= HtmlService.createHtmlOutputFromFile('AIClient').getContent(); ?>
</script>
<!-- âœ… ØªØ±ØªÙŠØ¨ Ù…ÙˆØ­Ù‘Ø¯ + ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© + ØªÙ†Ø³ÙŠÙ‚ ØµÙ Ø§Ù„Ø¨Ø­Ø« -->
<style id="unified_mobile_layout">
  @media (max-width:1200px){
    .container{
      display:grid !important;
      grid-template-columns:1fr !important;
      grid-template-areas:
        "load"
        "results"
        "search"
        "exec"
        "person"
        "quick";
      gap:14px !important;
    }

    /* Ø§Ø±Ø¨Ø· Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ */
    #loadCard   { grid-area: load    !important; }
    #resultsBox { grid-area: results !important; }
    #searchCard { grid-area: search  !important; }
    #execCard   { grid-area: exec    !important; }
    #personCard { grid-area: person  !important; }
    #quickTools { grid-area: quick   !important; }

    /* Ø®ÙÙ‘Ù Ø§Ù„ÙƒØ±ÙˆØª Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    .card{
      background:transparent !important;
      border:0 !important;
      box-shadow:none !important;
      border-radius:12px !important;
      padding:12px !important;
      margin:0 !important;
    }

    /* Ø§Ù„Ø¨Ø­Ø«: Ø­Ù‚Ù„ + Ø²Ø± Ø§Ù„Ù„ØµÙ‚ Ø¬Ù†Ø¨ Ø¨Ø¹Ø¶ */
    #searchCard .row,
    #searchCard .row.stretch{
      display:grid !important;
      grid-template-columns:1fr auto !important;
      column-gap:8px !important;
      align-items:stretch !important;
      width:100% !important;
    }
    #idInput{
      width:100% !important; 
      min-height:44px !important; 
      font-size:16px !important;
    }
    #pasteSearchBtn{
      height:44px !important; 
      min-width:130px !important; 
      white-space:nowrap !important; 
      font-weight:700 !important;
    }
  }
</style>

<script>
/* âœ… JS Ø¯Ø§Ø¹Ù…: ÙŠØ¶Ù…Ù† ÙˆØ¶Ø¹ #quickTools Ø¨Ø¹Ø¯ #personCard (Ø¥Ù† ÙƒØ§Ù† Ø¸Ø§Ù‡Ø±) ÙˆØ¥Ù„Ø§ Ø¨Ø¹Ø¯ #execCard + ÙŠØ«Ø¨Øª Ø²Ø± Ø§Ù„Ù„ØµÙ‚ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø­Ù‚Ù„ */
(function(){
  var IDS = { results:'resultsBox', search:'searchCard', exec:'execCard', person:'personCard', quick:'quickTools' };

  function $(id){ return document.getElementById(id); }
  function visible(el){
    if (!el) return false;
    var cs = getComputedStyle(el);
    return el.offsetParent !== null && cs.display!=='none' && cs.visibility!=='hidden' && cs.opacity!=='0';
  }

  function placeQuickTools(){
    var qt = $(IDS.quick), exec = $(IDS.exec), person = $(IDS.person);
    if (!qt || !exec) return;

    var anchor = (person && visible(person)) ? person : exec;
    var parent = anchor.parentNode;

    // Ø§Ù†Ù‚Ù„ quickTools Ù„Ù†ÙØ³ Ø§Ù„Ø£Ø¨ Ø«Ù… Ø¶Ø¹Ù‡ Ø¨Ø¹Ø¯ Ø§Ù„Ù€ anchor
    if (qt.parentNode !== parent) parent.appendChild(qt);
    if (qt.previousElementSibling !== anchor) parent.insertBefore(qt, anchor.nextSibling);

    // Ø¶Ø¨Ø· Ù‚ÙŠØ§Ø³Ø§Øª Ù„Ø·ÙŠÙØ©
    qt.style.maxWidth = '780px';
    qt.style.width    = '100%';
    qt.style.margin   = '12px auto';
  }

  function fixSearchRow(){
    var sc = $(IDS.search);
    if (!sc) return;
    // ØªØ£ÙƒØ¯ Ø£Ù† Ø²Ø± Ø§Ù„Ù„ØµÙ‚ Ø£Ø® Ù„Ù„Ø­Ù‚Ù„ Ø¯Ø§Ø®Ù„ Ù†ÙØ³ ØµÙ .row
    var input = sc.querySelector('#idInput');
    var btn   = document.getElementById('pasteSearchBtn');
    var row   = sc.querySelector('.row') || sc.querySelector('.row.stretch') || sc;
    if (input && btn && row && btn.parentNode !== row){
      row.appendChild(btn);
    }
    // ÙØ±Ø¶ Ø§Ù„Ø´Ø¨ÙƒØ© (Ø§Ø­ØªÙŠØ§Ø· Ù„Ùˆ ÙƒØ³Ø±Øª Ù‚ÙˆØ§Ø¹Ø¯ Ø³Ø§Ø¨Ù‚Ø©)
    row.style.display = 'grid';
    row.style.gridTemplateColumns = '1fr auto';
    row.style.columnGap = '8px';
    row.style.alignItems = 'stretch';
  }

  function run(){
    placeQuickTools();
    fixSearchRow();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run);
  } else {
    run();
  }

  // Ø±Ø§Ù‚Ø¨ Ø£ÙŠ ØªØºÙŠÙ‘Ø± ÙˆØ£Ø¹Ø¯ Ø§Ù„ØªØ±ØªÙŠØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
  var obs = new MutationObserver(run);
  obs.observe(document.body, { childList:true, subtree:true, attributes:true, attributeFilter:['style','class'] });
  window.addEventListener('resize', run);
})();
</script>
<script>
(function(){
  if (typeof renderResult !== 'function') return;
  const _orig = renderResult;

  renderResult = function(res){
    // Ø§Ø±Ø³Ù… Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ (Ø§Ù„Ø±Ø§ØªØ¨/Ø§Ù„Ø­Ø§Ù„Ø©â€¦)
    _orig(res);

    // Ø«Ù… Ø¹Ø²Ù‘Ø² "Ù…ÙƒØ±Ø±" Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙˆØ±Ù‹Ø§
    try{
      const dupBadge = document.getElementById('dupBadge'); // Ø´Ø§Ø±Ø© "Ù…ÙƒØ±Ø±" Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      const id = (res && res.id) ? String(res.id).trim() : '';

      // Ù„Ùˆ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø³Ù‡ Ù…Ø§ Ø±Ø¬Ù‘Ø¹ "Ù…ÙƒØ±Ø±"ØŒ Ø¨Ø³ Ù†Ø­Ù†Ø§ Ø´Ø§ÙŠÙÙŠÙ† ØªÙ†ÙÙŠØ° ÙÙˆØ±ÙŠ Ù„Ù‡Ø§Ù„Ù€ID
      const serverSaysDup = !!(res && (res.isDuplicate || res.dupFlavor));
      if (id && justColored[id] && !serverSaysDup) {
        if (dupBadge){
          dupBadge.style.display = '';
          dupBadge.textContent = (justColored[id] === 'both') ? 'Ù…ÙƒØ±Ø±' : 'Ù…ÙƒØ±Ø± ÙˆÙƒØ§Ù„Ø© ÙÙ‚Ø·';
        }
        // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø§Ù…Ø³Ø­ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ø¥Ø¸Ù‡Ø§Ø± Ù„Ø­ØªÙ‰ Ù…Ø§ ØªØ¶Ù„ Ù…Ø¹Ùƒ
        // delete justColored[id];
      } else if (dupBadge && !serverSaysDup) {
        // Ù…Ø§ ÙÙŠ Ù„Ø§ Ù…Ø­Ù„ÙŠ ÙˆÙ„Ø§ Ø³ÙŠØ±ÙØ± â†’ Ø£Ø®ÙÙ Ø§Ù„Ø´Ø§Ø±Ø©
        dupBadge.style.display = 'none';
      }
    }catch(_){}
  };

  // Ù†Ø¸Ø§ÙØ© Ø¨ØµØ±ÙŠØ©: Ù„Ù…Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„Ù€ID Ø£Ùˆ ÙŠØ¨Ø¯Ø£ Ø¨Ø­Ø« Ø¬Ø¯ÙŠØ¯ Ø§Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Ø±Ø© Ø¨Ø³Ø±Ø¹Ø©
  try {
    const idInput = document.getElementById('idInput');
    if (idInput){
      idInput.addEventListener('input', ()=>{
        const dupBadge = document.getElementById('dupBadge');
        if (dupBadge) dupBadge.style.display = 'none';
      });
    }
    if (typeof renderLoading === 'function'){
      const _rl = renderLoading;
      renderLoading = function(){
        _rl();
        const dupBadge = document.getElementById('dupBadge');
        if (dupBadge) dupBadge.style.display = 'none';
      };
    }
  } catch (_){}
})();
</script>
</body>
</html>