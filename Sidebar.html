<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø£Ø¯Ø§Ø© Ø§Ù„Ø¨Ø­Ø«</title>
  <style>
    :root{
      --bg:#04090f;
      --card:#0d151b;
      --panel:#101b22;
      --border:#1a2a33;
      --text:#effef7;
      --muted:#7ca5ad;
      --accent:#18f892;
      --accent-strong:#35ffb2;
      --accent-fade:rgba(24,248,146,0.16);
      --danger:#f97373;
      --warning:#facc15;
      --info:#38bdf8;
      --purple:#a855f7;
      --agent:#22d3ee;
      --shadow:0 16px 40px rgba(0,0,0,.32);
    }
    *{box-sizing:border-box;}
    body{margin:0;background:var(--bg);color:var(--text);font-family:'Tajawal','Cairo','Rubik','Segoe UI',sans-serif;min-height:100vh;display:flex;justify-content:center;}
    body.dark{background:var(--bg);}
    body:not(.dark){background:#f4f7fb;color:#0f172a;}
    .app-shell{width:100%;max-width:420px;padding:24px 18px 96px;position:relative;}
    body:not(.dark) .app-shell{color:#0f172a;}
    body:not(.dark) .card{background:#ffffff;border:1px solid rgba(15,23,42,.08);box-shadow:0 14px 28px rgba(15,23,42,.08);color:#0f172a;}
    body:not(.dark) .muted{color:#64748b;}
    body:not(.dark) .status-value{color:#047857;text-shadow:none;}
    body:not(.dark) .status-name{color:#1e293b;}
    body:not(.dark) .menu-panel{background:#ffffff;color:#0f172a;border-color:rgba(15,23,42,.12);}
    body:not(.dark) .menu-btn{background:#f1f5f9;color:#0f172a;border-color:rgba(15,23,42,.12);}
    body:not(.dark) .menu-btn.accent{color:#022012;}
    body:not(.dark) .menu-overlay{background:rgba(15,23,42,.2);}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:20px;}
    .menu-toggle{width:52px;height:52px;border-radius:26px;border:1px solid var(--border);background:linear-gradient(145deg,#0a1419,#121e24);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.3s;}
    .menu-toggle span{display:block;width:22px;height:3px;border-radius:4px;background:var(--accent);transition:.3s;}
    .menu-toggle span + span{margin-top:4px;}
    .menu-toggle:active{transform:scale(.96);}
    .topbar-stats{display:flex;flex-direction:column;gap:4px;text-align:right;font-size:14px;font-weight:600;}
    .topbar-stats .stat{display:flex;align-items:center;gap:6px;}
    .topbar-stats strong{font-size:16px;color:var(--accent);}
    .last-id-pill{padding:10px 14px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.02);font-size:13px;font-weight:700;display:flex;align-items:center;gap:6px;white-space:nowrap;}
    .card{background:linear-gradient(180deg,#101a20,#0c1418);border:1px solid rgba(255,255,255,.04);border-radius:22px;padding:18px 20px;margin-bottom:16px;box-shadow:var(--shadow);}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:nowrap;}
    .load-card{display:flex;flex-direction:column;gap:10px;}
    .load-actions{display:flex;gap:12px;align-items:center;}
    .load-btn{flex:1;}
    .load-btn--ok{background:linear-gradient(135deg,#4ade80,#22c55e);color:#022012;box-shadow:0 10px 24px rgba(34,197,94,.3);}
    .load-btn--error{background:linear-gradient(135deg,#fb7185,#ef4444);color:#fff5f5;box-shadow:0 10px 24px rgba(239,68,68,.35);}
    .load-note{min-height:18px;}
    .status-card{text-align:center;padding-top:24px;padding-bottom:24px;}
    .status-header{display:flex;justify-content:center;align-items:center;gap:10px;margin-bottom:16px;}
    .status-pill{display:inline-flex;align-items:center;justify-content:center;padding:8px 16px;border-radius:999px;font-weight:800;font-size:14px;letter-spacing:.4px;text-transform:none;background:rgba(255,255,255,.06);color:var(--text);border:1px solid rgba(255,255,255,.08);min-width:120px;}
    .status-pill--loading{background:rgba(255,255,255,.08);color:var(--muted);}
    .status-pill--withdraw{background:linear-gradient(120deg,#16f68f,#0ea968);color:#041b11;box-shadow:0 0 16px rgba(22,246,143,.35);}
    .status-pill--admin{background:linear-gradient(120deg,#60a5fa,#2563eb);color:#031226;}
    .status-pill--agent{background:linear-gradient(120deg,#22d3ee,#0891b2);color:#02131d;}
    .status-pill--salary{background:linear-gradient(120deg,#c084fc,#9333ea);color:#210631;}
    .status-pill--missing{background:linear-gradient(120deg,#f87171,#ef4444);color:#2c0303;}
    .status-pill--default{background:linear-gradient(120deg,#14f3ff,#1d4ed8);color:#011420;}
    .status-pill--dup{background:linear-gradient(120deg,#fde68a,#fbbf24);color:#2c1602;}
    .status-name{font-size:15px;font-weight:600;color:rgba(255,255,255,.82);margin-bottom:8px;}
    .status-value{font-size:64px;font-weight:900;color:var(--accent);text-shadow:0 0 24px rgba(47,255,185,.6);margin-bottom:6px;}
    .status-sub{font-size:13px;color:var(--muted);margin-bottom:4px;}
    .status-extra{font-size:12px;color:rgba(255,255,255,.6);}
    .status-chips{display:flex;flex-wrap:wrap;justify-content:center;gap:6px;margin-top:12px;}
    .search-card{padding:18px 20px;}
    .field-label{font-size:13px;color:var(--muted);display:block;margin-bottom:8px;}
    .search-row{display:flex;gap:12px;}
    input[type="text"],input[type="number"],select,textarea{width:100%;padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(5,12,16,.92);color:var(--text);font-size:16px;font-family:inherit;transition:border .2s,box-shadow .2s;}
    input[type="text"]:focus,input[type="number"]:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-fade);}
    textarea{min-height:140px;resize:vertical;}
    .btn{border:0;border-radius:16px;padding:12px 18px;font-weight:800;font-size:16px;cursor:pointer;transition:transform .2s,box-shadow .2s;}
    .btn:active{transform:scale(.97);}
    .btn.primary{background:linear-gradient(135deg,var(--accent-strong),var(--accent));color:#022012;box-shadow:0 10px 30px rgba(31,255,174,.35);}
    .btn.action{width:100%;background:linear-gradient(135deg,#16f2a1,#00bb7a);color:#042017;font-size:20px;padding:18px;}
    .btn.ghost{background:rgba(255,255,255,.04);color:var(--text);border:1px solid rgba(255,255,255,.08);}
    .btn.ghost:hover{border-color:var(--accent);}
    .btn.btn-danger{background:linear-gradient(135deg,#fb7185,#ef4444);color:#fff5f5;box-shadow:0 10px 30px rgba(239,68,68,.35);}
    .btn.btn-danger:hover{box-shadow:0 12px 34px rgba(239,68,68,.5);}
    .icon-btn{width:46px;height:46px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);color:var(--text);font-size:18px;cursor:pointer;}
    .icon-btn:hover{border-color:var(--accent);}
    .exec-card{padding:22px 20px;}
    .exec-header{display:flex;flex-direction:column;gap:12px;margin-bottom:18px;}
    .exec-group{margin-bottom:18px;}
    .pill-row{display:flex;gap:10px;align-items:center;}
    .pill-select{appearance:none;-webkit-appearance:none;background:rgba(255,255,255,.03);border-radius:16px;padding:12px 16px;border:1px solid rgba(255,255,255,.08);color:var(--text);font-weight:600;}
    .exec-colors .color-row{display:flex;gap:12px;flex-wrap:wrap;}
    .color-chip{flex:1;min-width:150px;background:rgba(255,255,255,.03);padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;font-size:14px;font-weight:700;}
    .color-chip input{width:46px;height:46px;border-radius:12px;border:1px solid rgba(255,255,255,.2);padding:0;background:transparent;}
    .discount-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
    .discount-row input[type="number"]{max-width:90px;text-align:center;}
    .toggle{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.03);padding:10px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.08);font-size:13px;font-weight:700;}
    .toggle input{appearance:none;-webkit-appearance:none;width:0;height:0;position:absolute;opacity:0;}
    .toggle .slider{position:relative;width:48px;height:26px;background:rgba(255,255,255,.1);border-radius:999px;transition:.3s;}
    .toggle .slider::before{content:"";position:absolute;width:22px;height:22px;left:2px;top:2px;border-radius:50%;background:#fff;transition:.3s;}
    .toggle input:checked + .slider{background:var(--accent);}
    .toggle input:checked + .slider::before{transform:translateX(22px);background:#032316;}
    .muted{color:var(--muted);font-size:13px;}
    .search-meta{margin-top:10px;}
    .person-card textarea{margin-top:14px;}
    .person-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:10px;}
    .person-actions{display:flex;gap:10px;}
    .note-success{background:rgba(24,248,146,.12);border:1px solid rgba(24,248,146,.45);color:var(--accent);padding:12px 14px;border-radius:16px;font-weight:700;line-height:1.6;margin-top:6px;}
    .note-success strong{display:block;font-size:15px;color:#b0ffda;}
    #advNote{min-height:38px;}
    .menu-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);z-index:9999;padding:20px;}
    body.menu-open .menu-overlay{display:flex;}
    .menu-panel{width:100%;max-width:360px;background:linear-gradient(180deg,#101a20,#0a1116);border:1px solid rgba(255,255,255,.06);border-radius:24px;padding:24px 20px;box-shadow:var(--shadow);position:relative;display:flex;flex-direction:column;gap:16px;}
    .menu-close{position:absolute;top:14px;left:14px;width:38px;height:38px;border-radius:50%;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.04);color:var(--text);font-size:20px;cursor:pointer;}
    .menu-header{font-size:20px;font-weight:800;text-align:center;margin-bottom:8px;}
    .menu-buttons{display:flex;flex-direction:column;gap:12px;}
    .menu-btn{width:100%;padding:16px;border-radius:18px;font-weight:800;font-size:16px;cursor:pointer;background:rgba(255,255,255,.06);color:var(--text);border:1px solid rgba(255,255,255,.08);}
    .menu-btn.accent{background:linear-gradient(135deg,var(--accent-strong),var(--accent));color:#021e12;box-shadow:0 12px 26px rgba(24,248,146,.32);}
    .menu-btn:hover{border-color:var(--accent);}
    .menu-btn.menu-btn--ok{background:linear-gradient(135deg,#4ade80,#22c55e);color:#062a16;box-shadow:0 12px 28px rgba(34,197,94,.35);}
    .menu-btn.menu-btn--error{background:linear-gradient(135deg,#fb7185,#ef4444);color:#fff0f0;box-shadow:0 12px 28px rgba(239,68,68,.4);}
    .menu-switch{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;border-radius:16px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);font-weight:700;}
    .menu-switch input{appearance:none;-webkit-appearance:none;width:0;height:0;opacity:0;position:absolute;}
    .menu-switch .slider{position:relative;width:54px;height:28px;background:rgba(255,255,255,.14);border-radius:999px;transition:.3s;}
    .menu-switch .slider::before{content:"";position:absolute;width:24px;height:24px;left:2px;top:2px;background:#fff;border-radius:50%;transition:.3s;}
    .menu-switch input:checked + .slider{background:var(--accent);}
    .menu-switch input:checked + .slider::before{transform:translateX(24px);background:#032316;}
    .menu-link{width:100%;padding:12px;border-radius:14px;background:rgba(255,255,255,.02);color:var(--muted);border:1px solid rgba(255,255,255,.04);font-weight:600;cursor:pointer;}
    .menu-note{font-size:12px;line-height:1.6;}
    .search-row button{flex:0 0 auto;}
    .flash-blue{animation:flashGlowBlue .46s ease;}
    .flash-green{animation:flashGlowGreen .46s ease;}
    @keyframes flashGlowBlue{0%{box-shadow:0 0 0 0 rgba(56,189,248,0);}40%{box-shadow:0 0 0 14px rgba(56,189,248,.28);}100%{box-shadow:0 0 0 0 rgba(56,189,248,0);}}
    @keyframes flashGlowGreen{0%{box-shadow:0 0 0 0 rgba(16,185,129,0);}40%{box-shadow:0 0 0 14px rgba(16,185,129,.3);}100%{box-shadow:0 0 0 0 rgba(16,185,129,0);}}
    #logAnchor{margin-top:12px;}
    .bulk-area{display:none;margin-top:24px;}
    body.show-bulk .bulk-area{display:block;}
    .bulk-area .card{box-shadow:none;background:rgba(8,14,19,.9);border:1px solid rgba(255,255,255,.05);}
    #bulkCard h3{margin:0 0 10px;font-size:18px;font-weight:800;}
    .bulk-note{font-size:12px;color:var(--muted);margin-bottom:10px;}
    #bulkPasteRow{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:stretch;margin-top:12px;}
    .bulk-paste-grid{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:stretch;}
    #bulkActionsRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
    #bulkActionsRow button{flex:1 1 150px;min-height:44px;}
    #bulkPasteBtn{min-width:120px;min-height:44px;}
    #bulkIds{min-height:180px;font-size:16px;}
    #searchCard .paste-row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:stretch;}
    #idInput{font-size:18px;font-weight:600;text-align:center;}
    .bulk-progress{height:6px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden;margin-top:10px;}
    .bulk-progress-bar{height:100%;width:0;background:var(--accent);transition:width .3s ease;}
    .bulk-progress-text{font-size:12px;color:var(--muted);margin-top:6px;display:flex;justify-content:space-between;align-items:center;gap:8px;}
    .bulk-counters{display:flex;flex-wrap:wrap;gap:12px;margin-top:10px;font-size:12px;color:var(--muted);}
    .bulk-counters b{font-size:13px;color:var(--text);}
    .bulk-table{width:100%;border-collapse:collapse;margin-top:14px;font-size:13px;}
    .bulk-table th,.bulk-table td{padding:8px 10px;text-align:right;border-bottom:1px solid rgba(255,255,255,.08);}
    .bulk-table th{font-weight:700;color:var(--muted);background:rgba(255,255,255,.03);}
    .bulk-table tbody tr:nth-child(even){background:rgba(255,255,255,.02);}
    .bulk-table .state-cell{font-weight:700;}
    .bulk-chip{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;font-size:11px;background:rgba(248,113,113,.16);color:#fecaca;}
    .bulk-empty{padding:20px;border:1px dashed rgba(255,255,255,.08);border-radius:12px;text-align:center;font-size:13px;color:var(--muted);margin-top:12px;}
    .bulk-toolbar{display:none;}
    .bulk-pagination{display:none;align-items:center;gap:12px;margin-top:12px;flex-wrap:wrap;justify-content:space-between;}
    .bulk-page-btn{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.02);padding:8px 14px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;color:var(--text);}
    .bulk-page-btn:disabled{opacity:.55;cursor:not-allowed;}
    .bulk-page-info{flex:1;text-align:center;font-size:12px;color:var(--muted);}
    #bulkToggleCard{display:none;}
    #bulkCard{display:none;}
    #bulkMobileMount{display:none;}
    body.show-bulk #bulkToggleCard{display:block;}
    body.show-bulk #bulkCard{display:block;}
    body.show-bulk #bulkMobileMount{display:grid;gap:12px;}
    @media(min-width:700px){
      body{padding-top:30px;}
      .app-shell{max-width:460px;}
    }
  </style>
</head>
<body class="neo dark">
  <div class="app-shell">
    <header class="topbar">
      <button id="menuToggle" class="menu-toggle" type="button" aria-label="ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div class="topbar-stats">
        <div class="stat">Ù…Ù„ÙˆÙ†: <strong id="qtColored">â€”</strong></div>
        <div class="stat">ØºÙŠØ± Ù…Ù„ÙˆÙ†: <strong id="qtUncolored">â€”</strong></div>
      </div>
      <div id="lastIdPill" class="last-id-pill" style="display:none">
        Ø¢Ø®Ø± ID: <b id="lastIdText"></b>
      </div>
    </header>

    <main class="main-flow">
      <section id="loadCard" class="card load-card">
        <div class="load-actions">
          <button id="reloadBtn" class="btn primary load-btn">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
        <div id="loadNote" class="muted load-note"></div>
      </section>

      <section id="resultsBox" class="card status-card">
        <div class="status-header">
          <span id="statusBadge" class="status-pill status-pill--loading">â€”</span>
          <span id="dupBadge" class="status-pill status-pill--dup" style="display:none">Ù…ÙƒØ±Ø±</span>
        </div>
        <div id="amountText" class="status-value">â€”</div>
        <div id="nameText" class="status-name">â€”</div>
        <div id="multiText" class="status-sub"></div>
        <div id="extraDupInfo" class="status-extra"></div>
        <div id="statusChipsRow" class="status-chips"></div>
      </section>

      <section id="searchCard" class="card search-card">
        <label class="field-label" for="idInput">ID Ù„Ù„Ø¨Ø­Ø«</label>
        <div class="search-row">
          <input id="idInput" type="text" placeholder="Ø£Ø¯Ø®Ù„ ID Ù‡Ù†Ø§" autocomplete="off" inputmode="numeric">
          <button id="pasteSearchBtn" class="btn primary">Ù„ØµÙ‚ Ø«Ù… Ø¨Ø­Ø«</button>
        </div>
        <div class="search-meta">
          <div id="pasteHint" class="muted"></div>
        </div>
      </section>

      <section id="execCard" class="card exec-card">
        <div class="exec-header">
          <button id="advRunBtn" class="btn action">ØªÙ†ÙÙŠØ°</button>
          <div id="advNote" class="muted"></div>
        </div>

        <div class="exec-group">
          <label class="field-label" for="sheetSelect">Ø§Ù„Ù‡Ø¯Ù</label>
          <div class="pill-row">
            <select id="sheetSelect" class="pill-select"></select>
            <button id="refreshSheetsBtn" class="icon-btn" title="ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚">â†»</button>
          </div>
        </div>

        <div class="exec-group">
          <label class="field-label" for="targetMode">Ø§Ù„ØªÙ†ÙÙŠØ°</label>
          <select id="targetMode" class="pill-select">
            <option value="agent">Ø§Ù„ÙˆÙƒÙŠÙ„ ÙÙ‚Ø·</option>
            <option value="both" selected>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© + Ø§Ù„ÙˆÙƒÙŠÙ„</option>
          </select>
        </div>

        <div class="exec-group exec-colors">
          <label class="field-label">Ø§Ù„Ø£Ù„ÙˆØ§Ù†</label>
          <div class="color-row">
            <div class="color-chip">
              <span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
              <input id="adminColor" type="color" value="#fde68a">
            </div>
            <div class="color-chip">
              <span>Ø³Ø­Ø¨ Ø§Ù„ÙˆÙƒØ§Ù„Ø©</span>
              <input id="withdrawColor" type="color" value="#ddd6fe">
            </div>
          </div>
        </div>

        <div class="exec-group">
          <label class="field-label" for="newSheetName">Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø©</label>
          <div class="pill-row">
            <input id="newSheetName" type="text" placeholder="Ø§Ø³Ù… ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)">
            <button id="createSheetBtn" class="btn ghost">Ø¥Ù†Ø´Ø§Ø¡</button>
          </div>
        </div>

        <div class="exec-group">
          <label class="field-label">Ø§Ù„Ø®ØµÙ…</label>
          <div class="discount-row">
            <input id="discountInput" type="number" min="0" max="100" value="0" step="1">
            <span class="muted">%</span>
            <label class="toggle">
              <span>Ø§Ù„Ø®ØµÙ… Ù„Ø­Ø¸ÙŠÙ‹Ø§</span>
              <input id="applyDiscountToMessage" type="checkbox">
              <span class="slider"></span>
            </label>
            <label class="toggle">
              <span>ØªØµØ­ÙŠØ­ Ø§Ù„Ø±Ø§ØªØ¨</span>
              <input id="enableSalaryCorrection" type="checkbox">
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div id="aiMountHere"></div>
        <div id="afterAiHook"></div>
      </section>

      <section id="personCard" class="card person-card" style="display:none">
        <div class="person-header">
          <strong>Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ø­Ø¨ Ø§Ù„Ù€ID</strong>
          <div class="person-actions">
            <button id="copyMsgBtn" class="btn ghost">Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
            <button id="colorAllBtn" class="btn ghost">ØªÙ„ÙˆÙŠÙ† Ø§Ù„ÙƒÙ„</button>
          </div>
        </div>
        <div id="personNote" class="muted">â€”</div>
        <textarea id="personMsg" rows="8" readonly></textarea>
      </section>

      <div id="logAnchor"></div>
    </main>

    <div class="bulk-area" id="bulkArea">
      <div class="card" id="bulkToggleCard">
        <div class="menu-buttons" style="gap:8px;">
          <button id="bulkToggleBtn" class="btn primary" style="min-width:130px">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø©</button>
        </div>
        <div id="bulkToggleNote" class="muted" style="margin-top:6px">ØªØ¸Ù‡Ø± Ø§Ù„Ø£Ø¯Ø§Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ (20 Ù†ØªÙŠØ¬Ø© Ù„ÙƒÙ„ ØµÙØ­Ø©).</div>
      </div>

      <div id="bulkMobileMount" class="span2"></div>

      <div class="card" id="bulkCard">
        <h3>Ø£Ø¯Ø§Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ</h3>
        <div class="bulk-note" id="bulkStatusText">Ø£Ù„ØµÙ‚ IDs ÙˆØ³ÙŠØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>

        <div class="row" style="gap:12px; flex-wrap:wrap; align-items:flex-end">
          <div style="flex:1; min-width:180px">
            <label class="field-label">Ø§Ù„Ù†Ø·Ø§Ù‚</label>
            <select id="bulkScope">
              <option value="agent">Ø§Ù„ÙˆÙƒÙŠÙ„ ÙÙ‚Ø·</option>
              <option value="both" selected>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© + Ø§Ù„ÙˆÙƒÙŠÙ„</option>
              <option value="all">Ø§Ù„ÙƒÙ„ (ÙŠØ´Ù…Ù„ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ)</option>
            </select>
          </div>
          <div style="flex:1; min-width:220px">
            <label class="field-label">ÙˆØ±Ù‚Ø© Ø§Ù„Ù‡Ø¯Ù</label>
            <div class="pill-row">
              <select id="bulkTargetSheet" style="flex:1"></select>
              <button id="bulkRefreshSheets" class="icon-btn" title="ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚" style="flex:0 0 auto">â†»</button>
            </div>
          </div>
        </div>

        <div class="pill-row" style="margin-top:10px">
          <input id="bulkNewSheet" type="text" placeholder="Ø§Ø³Ù… ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)">
          <button id="bulkCreateSheet" class="btn ghost">Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø©</button>
        </div>

        <div id="bulkExternalWrap" style="margin-top:12px; display:none">
          <label class="field-label">ÙˆØ±Ù‚Ø© Ø§Ù„Ù‡Ø¯Ù (Ø®Ø§Ø±Ø¬ÙŠ) <span id="bulkExternalFileLabel" class="muted"></span></label>
          <div class="pill-row">
            <select id="bulkExternalTargetSheet" style="flex:1"></select>
            <button id="bulkExternalRefreshSheets" class="icon-btn" title="ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©" style="flex:0 0 auto">â†»</button>
          </div>
          <div class="pill-row" style="margin-top:8px">
            <input id="bulkExternalNewSheet" type="text" placeholder="Ø§Ø³Ù… ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø®Ø§Ø±Ø¬ÙŠØ©)">
            <button id="bulkExternalCreateSheet" class="btn ghost">Ø¥Ù†Ø´Ø§Ø¡</button>
          </div>
          <div id="bulkExternalNote" class="muted" style="margin-top:6px"></div>
        </div>

        <div class="exec-group" style="margin-top:10px">
          <div class="color-row" style="gap:14px;flex-wrap:wrap">
            <div class="color-chip" style="min-width:180px">
              <span>Ù„ÙˆÙ† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
              <input id="bulkAdminColor" type="color" value="#fde68a">
            </div>
            <div class="color-chip" style="min-width:180px">
              <span>Ù„ÙˆÙ† Ø§Ù„ÙˆÙƒÙŠÙ„ / Ø³Ø­Ø¨ Ø§Ù„ÙˆÙƒØ§Ù„Ø©</span>
              <input id="bulkWithdrawColor" type="color" value="#ddd6fe">
            </div>
          </div>
        </div>

        <div class="discount-row" style="margin-top:12px">
          <label class="field-label" style="margin:0">Ø§Ù„Ø®ØµÙ… %</label>
          <input id="bulkDiscount" type="number" min="0" max="100" value="0" step="1" style="width:110px">
          <div class="muted" id="bulkDiscountNote">ÙŠÙØ·Ø¨Ù‘Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬.</div>
        </div>

        <div id="bulkPasteRow">
          <textarea id="bulkIds" placeholder="Ø£Ù„ØµÙ‚ Ø¹Ø¯Ø© IDs (Ø³Ø·Ø± Ù„ÙƒÙ„ ID Ø£Ùˆ Ù…ÙØµÙˆÙ„Ø© Ø¨Ù…Ø³Ø§ÙØ§Øª)"></textarea>
          <button id="bulkPasteBtn" class="btn primary">Ù„ØµÙ‚ Ø«Ù… Ø¨Ø­Ø«</button>
        </div>
        <div id="bulkActionsRow">
          <button id="bulkAnalyzeBtn" class="btn primary">ØªØ­Ù„ÙŠÙ„</button>
          <button id="bulkExecuteBtn" class="btn ghost" disabled>ØªÙ†ÙÙŠØ° Ø§Ù„ÙƒÙ„</button>
          <button id="bulkCopyAllBtn" class="btn ghost" disabled>Ù†Ø³Ø® Ø§Ù„ÙƒÙ„</button>
          <button id="bulkCopySalaryBtn" class="btn ghost" disabled>Ù†Ø³Ø® Ø§Ù„Ø±ÙˆØ§ØªØ¨</button>
          <button id="bulkResetBtn" class="btn ghost">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>

        <div class="bulk-progress">
          <div id="bulkProgressBar" class="bulk-progress-bar"></div>
        </div>
        <div class="bulk-progress-text">
          <span id="bulkProgressLabel">0%</span>
          <span id="bulkSummaryText"></span>
        </div>

        <div class="bulk-counters">
          <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª: <b id="bulkCountTotal">0</b></div>
          <div>Ù…Ù„ÙˆÙ‘Ù†: <b id="bulkCountColored">0</b></div>
          <div>ØºÙŠØ± Ù…Ù„ÙˆÙ‘Ù†: <b id="bulkCountUncolored">0</b></div>
          <div>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø±ÙˆØ§ØªØ¨: <b id="bulkSalarySum">0</b></div>
        </div>

        <table class="bulk-table" style="margin-top:12px">
          <thead>
            <tr>
              <th>#</th>
              <th>ID</th>
              <th>Ø§Ù„Ø±Ø§ØªØ¨</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ù…Ù„ÙˆÙ‘Ù†ØŸ</th>
            </tr>
          </thead>
          <tbody id="bulkResultsBody"></tbody>
        </table>
        <div id="bulkPagination" class="bulk-pagination">
          <button id="bulkPrevBtn" class="bulk-page-btn">â€¹ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
          <span id="bulkPageInfo" class="bulk-page-info"></span>
          <button id="bulkNextBtn" class="bulk-page-btn">Ø§Ù„ØªØ§Ù„ÙŠ â€º</button>
        </div>
        <div id="bulkEmptyState" class="bulk-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯.</div>
      </div>
    </div>
  </div>

  <div id="quickTools" class="menu-overlay">
    <div class="menu-panel">
      <button id="menuClose" class="menu-close" aria-label="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">Ã—</button>
      <div class="menu-header">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
      <div id="loadMenuCard" class="menu-buttons" style="gap:12px;">
        <button id="reloadBtnMenu" class="menu-btn accent">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <div id="loadNoteMirror" class="menu-note muted"></div>
      </div>
      <div class="menu-buttons">
        <button id="menuHome" class="menu-btn">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button id="qtMode" class="menu-btn">ğŸŒ™ ÙˆØ¶Ø¹ Ø¯Ø§ÙƒÙ†</button>
        <button id="menuBulk" class="menu-btn">Ø£Ø¯Ø§Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ</button>
        <button id="qtHidePerson" class="menu-btn">ØªÙØ¹ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>
      <label class="menu-switch">
        <span>ØªØ¹Ø·ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        <input id="qtDisablePerson" type="checkbox">
        <span class="slider"></span>
      </label>
      <button id="qtHideLoad" class="menu-link">Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„</button>
      <button id="qtRefreshCnt" class="menu-link">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯</button>
    </div>
  </div>

<script>
    (function(){
    // Ø¹Ù†Ø§ØµØ± Ø¹Ø§Ù…Ø©
    const reloadBtn      = document.getElementById('reloadBtn');
    const reloadBtnMenu  = document.getElementById('reloadBtnMenu');
    const loadNote       = document.getElementById('loadNote');
    const loadNoteMirror = document.getElementById('loadNoteMirror');
    const loadCardSection= document.getElementById('loadCard');
    const menuOverlay    = document.getElementById('quickTools');
    const menuToggle     = document.getElementById('menuToggle');
    const menuClose      = document.getElementById('menuClose');
    const menuHome       = document.getElementById('menuHome');
    const menuBulk       = document.getElementById('menuBulk');

    const idInput        = document.getElementById('idInput');
    const pasteSearchBtn = document.getElementById('pasteSearchBtn');
    const pasteHint      = document.getElementById('pasteHint');

    const resultsBox  = document.getElementById('resultsBox');
    const statusBadge = document.getElementById('statusBadge');
    const dupBadge    = document.getElementById('dupBadge');
    const amountText  = document.getElementById('amountText');
    const multiText   = document.getElementById('multiText');
    const extraDupInfo= document.getElementById('extraDupInfo');
    const justColored = Object.create(null);
    const bodyEl = document.body;
    const BULK_AREA_KEY = 'home_show_bulk';

    const bulkCardEl         = document.getElementById('bulkCard');
    const bulkScope          = document.getElementById('bulkScope');
    const bulkTargetSheet          = document.getElementById('bulkTargetSheet');
    const bulkRefreshSheets        = document.getElementById('bulkRefreshSheets');
    const bulkNewSheet             = document.getElementById('bulkNewSheet');
    const bulkCreateSheet          = document.getElementById('bulkCreateSheet');
    const bulkExternalWrap         = document.getElementById('bulkExternalWrap');
    const bulkExternalTargetSheet  = document.getElementById('bulkExternalTargetSheet');
    const bulkExternalRefreshSheets= document.getElementById('bulkExternalRefreshSheets');
    const bulkExternalNewSheet     = document.getElementById('bulkExternalNewSheet');
    const bulkExternalCreateSheet  = document.getElementById('bulkExternalCreateSheet');
    const bulkExternalNote         = document.getElementById('bulkExternalNote');
    const bulkExternalFileLabel    = document.getElementById('bulkExternalFileLabel');
    const bulkAdminColor           = document.getElementById('bulkAdminColor');
    const bulkWithdrawColor        = document.getElementById('bulkWithdrawColor');
    const bulkDiscount             = document.getElementById('bulkDiscount');
    const bulkIdsInput       = document.getElementById('bulkIds');
    const bulkPasteBtn       = document.getElementById('bulkPasteBtn');
    const bulkAnalyzeBtn     = document.getElementById('bulkAnalyzeBtn');
    const bulkExecuteBtn     = document.getElementById('bulkExecuteBtn');
    const bulkCopyAllBtn     = document.getElementById('bulkCopyAllBtn');
    const bulkCopySalaryBtn  = document.getElementById('bulkCopySalaryBtn');
    const bulkResetBtn       = document.getElementById('bulkResetBtn');
    const bulkProgressBar    = document.getElementById('bulkProgressBar');
    const bulkProgressLabel  = document.getElementById('bulkProgressLabel');
    const bulkSummaryText    = document.getElementById('bulkSummaryText');
    const bulkStatusText     = document.getElementById('bulkStatusText');
    const bulkCountTotal     = document.getElementById('bulkCountTotal');
    const bulkCountColored   = document.getElementById('bulkCountColored');
    const bulkCountUncolored = document.getElementById('bulkCountUncolored');
    const bulkSalarySum      = document.getElementById('bulkSalarySum');
    const bulkResultsBody    = document.getElementById('bulkResultsBody');
    const bulkEmptyState     = document.getElementById('bulkEmptyState');
    const bulkPagination     = document.getElementById('bulkPagination');
    const bulkPrevBtn        = document.getElementById('bulkPrevBtn');
    const bulkNextBtn        = document.getElementById('bulkNextBtn');
    const bulkPageInfo       = document.getElementById('bulkPageInfo');
    const bulkToggleBtn      = document.getElementById('bulkToggleBtn');
    const bulkToggleNote     = document.getElementById('bulkToggleNote');
    const bulkMobileMount    = document.getElementById('bulkMobileMount');
    const bulkAreaWrap       = document.getElementById('bulkArea');

    function escapeHtml(value) {
      return String(value ?? '').replace(/[&<>'"]/g, c => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[c] || c));
    }

    function setLoadNote(text){
      const value = text || '';
      if (loadNote) loadNote.textContent = value;
      if (loadNoteMirror) loadNoteMirror.textContent = value;
    }

    function clearAdvNote(){
      if (!advNote) return;
      advNote.classList.remove('note-success');
      advNote.classList.add('muted');
      advNote.innerHTML = '';
    }

    function showExecutionSuccess(id, mode, serverMessage){
      if (!advNote) return;
      const areas = [];
      if (mode === 'both'){ areas.push('Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', 'Ø§Ù„ÙˆÙƒÙŠÙ„'); }
      else if (mode === 'agent'){ areas.push('Ø§Ù„ÙˆÙƒÙŠÙ„'); }
      else if (mode === 'admin'){ areas.push('Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©'); }
      else { areas.push('Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ù…Ø­Ø¯Ø¯'); }
      const areaText = Array.from(new Set(areas.filter(Boolean))).join(' Ùˆ ') || 'â€”';
      advNote.classList.remove('muted');
      advNote.classList.add('note-success');
      const parts = [
        `<strong>ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¹Ù„Ù‰ ID ${escapeHtml(id)}</strong>`,
        `<div>ØªÙ… Ø§Ù„ØªÙ„ÙˆÙŠÙ† ÙÙŠ: ${escapeHtml(areaText)}.</div>`
      ];
      const trimmedMessage = String(serverMessage || '').trim();
      if (trimmedMessage && trimmedMessage !== 'ØªÙ… âœ…') {
        parts.push(`<div class="muted">${escapeHtml(trimmedMessage)}</div>`);
      }
      advNote.innerHTML = parts.join('');
    }

    function resolveStatusClass(baseStatus){
      const s = String(baseStatus || '').toLowerCase();
      if (!s) return 'status-pill--default';
      if (s.includes('Ø³Ø­Ø¨ ÙˆÙƒØ§Ù„Ø©')) return 'status-pill--withdraw';
      if (s.includes('Ø±Ø§Øª')) return 'status-pill--salary';
      if (s.includes('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯')) return 'status-pill--missing';
      if (s.includes('Ø§Ø¯Ø§Ø±Ø©')) return 'status-pill--admin';
      if (s.includes('ÙˆÙƒØ§Ù„Ø©')) return 'status-pill--agent';
      return 'status-pill--default';
    }

    function openMenu(){ bodyEl.classList.add('menu-open'); }
    function closeMenu(){ bodyEl.classList.remove('menu-open'); }

    function updateMenuBulkLabel(){
      if (!menuBulk) return;
      const active = bodyEl.classList.contains('show-bulk');
      menuBulk.textContent = active ? 'Ø¥Ø®ÙØ§Ø¡ Ø£Ø¯Ø§Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ' : 'Ø£Ø¯Ø§Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ';
    }

    function setBulkAreaState(active){
      bodyEl.classList.toggle('show-bulk', !!active);
      updateMenuBulkLabel();
      try { localStorage.setItem(BULK_AREA_KEY, active ? '1' : '0'); } catch(_){}
    }

    const bulkCardHome = bulkCardEl ? document.createComment('bulk-card-home') : null;
    if (bulkCardEl && bulkCardEl.parentNode && bulkCardHome) {
      bulkCardEl.parentNode.insertBefore(bulkCardHome, bulkCardEl);
    }

    try {
      if (localStorage.getItem(BULK_AREA_KEY) === '1') bodyEl.classList.add('show-bulk');
    } catch(_){ }
    updateMenuBulkLabel();

    if (menuToggle) menuToggle.addEventListener('click', ()=>{
      if (bodyEl.classList.contains('menu-open')) closeMenu();
      else openMenu();
    });
    if (menuClose) menuClose.addEventListener('click', closeMenu);
    if (menuOverlay) menuOverlay.addEventListener('click', e=>{ if (e.target === menuOverlay) closeMenu(); });
    if (menuHome) menuHome.addEventListener('click', ()=>{
      closeMenu();
      try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch(_){ window.scrollTo(0,0); }
    });
    if (menuBulk) menuBulk.addEventListener('click', ()=>{
      const next = !bodyEl.classList.contains('show-bulk');
      setBulkAreaState(next);
      closeMenu();
      if (next){
        const target = bulkAreaWrap || bulkCardEl || bulkToggleBtn;
        if (target){ setTimeout(()=>{ try { target.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(_){ } }, 200); }
      }
    });
    document.addEventListener('keydown', e=>{ if (e.key === 'Escape') closeMenu(); });

    // Ø¹Ù†ØµØ± Ù„Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù…Ù† Ø¹Ù…ÙˆØ¯ B)
    const nameText   = document.getElementById('nameText');
    const execCard  = document.getElementById('execCard');
    const advNote  = document.getElementById('advNote');
    const sheetSelect   = document.getElementById('sheetSelect');
    const refreshSheetsBtn = document.getElementById('refreshSheetsBtn');
    const newSheetName  = document.getElementById('newSheetName');
    const createSheetBtn= document.getElementById('createSheetBtn');
    const adminColor    = document.getElementById('adminColor');
    const withdrawColor = document.getElementById('withdrawColor');
    const targetModeSel = document.getElementById('targetMode');
    const advRunBtn     = document.getElementById('advRunBtn');

    const discountInput = document.getElementById('discountInput');
    const applyDiscountToMessage = document.getElementById('applyDiscountToMessage');
    const enableSalaryCorrection = document.getElementById('enableSalaryCorrection');

    // Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®Øµ
    const personCardEl = document.getElementById('personCard');
    const personNote   = document.getElementById('personNote');
    const personMsg    = document.getElementById('personMsg');
    const copyMsgBtn   = document.getElementById('copyMsgBtn');
    const colorAllBtn  = document.getElementById('colorAllBtn');

    // Ø¢Ø®Ø± ID
    const lastIdPill = document.getElementById('lastIdPill');
    const lastIdText = document.getElementById('lastIdText');

    // Ø£Ø¯ÙˆØ§Øª Ø³Ø±ÙŠØ¹Ø©
    const qtColored = document.getElementById('qtColored');
    const qtUncolored = document.getElementById('qtUncolored');
    const qtMode = document.getElementById('qtMode');
    const qtHide = document.getElementById('qtHideLoad');
    const qtRefreshCntBtn = document.getElementById('qtRefreshCnt');

    const qtHidePerson = document.getElementById('qtHidePerson');
    const qtDisablePerson = document.getElementById('qtDisablePerson');

    // Ø­Ø§Ù„Ø©
    let localMap = null;
    let lastResult = null;
    let lastProfileIds = [];
    let lastBaseId = '';

    let bulkIds = [];
    let bulkResults = [];
    let bulkBusy = false;
    let bulkAnalyzed = false;
    let bulkExecuted = false;
    let bulkAutoAnalyzeTimer = null;
    let bulkExternalAvailable = false;
    let bulkExternalDefaultName = '';
    let bulkExternalErrorMessage = '';
    let bulkPage = 1;
    let bulkMobileEnabled = false;

    const BULK_PAGE_SIZE = 20;
    const BULK_MOBILE_STORAGE_KEY = 'bulk_mobile_enabled';
    const JUST_COLORED_TTL = 120000;

    try {
      bulkMobileEnabled = localStorage.getItem(BULK_MOBILE_STORAGE_KEY) === '1';
    } catch (_) {
      bulkMobileEnabled = false;
    }

    const fmt = n => {
      const x = Number(n);
      return isNaN(x) ? 'â€”' : new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(x);
    };

    const runServer = (fnName, ...args) => new Promise((resolve, reject) => {
      try {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(err => reject(err))
          [fnName](...args);
      } catch (err) {
        reject(err);
      }
    });

    const parseBulkIds = txt => {
      return String(txt || '')
        .split(/[\s,\n\r]+/)
        .map(v => v.trim())
        .filter(v => !!v);
    };

    const isMobileLayout = () => window.matchMedia('(max-width: 1200px)').matches;

    function markJustColored(ids, mode){
      const arr = Array.isArray(ids) ? ids : [ids];
      const flavor = mode === 'agent' ? 'agent' : 'both';
      arr.forEach(id => {
        const key = String(id || '').trim();
        if (!key) return;
        justColored[key] = flavor;
        setTimeout(() => {
          if (justColored[key] === flavor) delete justColored[key];
        }, JUST_COLORED_TTL);
      });
    }

    function updateBulkPaginationUI(total, startIndex, endIndex, totalPages){
      if (!bulkPagination) return;
      if (!total){
        bulkPagination.style.display = 'none';
        if (bulkPageInfo) bulkPageInfo.textContent = '';
        if (bulkPrevBtn) bulkPrevBtn.disabled = true;
        if (bulkNextBtn) bulkNextBtn.disabled = true;
        return;
      }
      const pages = Math.max(1, totalPages || 1);
      const hasPages = total > BULK_PAGE_SIZE;
      bulkPagination.style.display = hasPages ? 'flex' : 'none';
      const start = Math.min(total, Math.max(1, startIndex + 1));
      const end = Math.min(total, Math.max(start, endIndex));
      if (bulkPageInfo){
        if (hasPages){
          bulkPageInfo.textContent = `Ø¹Ø±Ø¶ ${start} - ${end} Ù…Ù† ${total} (ØµÙØ­Ø© ${bulkPage}/${pages})`;
        } else {
          bulkPageInfo.textContent = `Ø¹Ø±Ø¶ ${total} Ù†ØªÙŠØ¬Ø©`;
        }
      }
      if (bulkPrevBtn) bulkPrevBtn.disabled = !hasPages || bulkPage <= 1;
      if (bulkNextBtn) bulkNextBtn.disabled = !hasPages || bulkPage >= pages;
    }

    function restoreBulkCardHome(){
      if (!bulkCardEl || !bulkCardHome || !bulkCardHome.parentNode) return;
      if (bulkCardEl.parentNode !== bulkCardHome.parentNode || bulkCardEl.previousSibling !== bulkCardHome) {
        bulkCardHome.parentNode.insertBefore(bulkCardEl, bulkCardHome.nextSibling);
      }
    }

    function applyBulkMobileState(options = {}){
      if (!bulkCardEl) return;
      const mobile = isMobileLayout();
      const active = bulkMobileEnabled && mobile;

      document.body.classList.toggle('bulk-mobile-active', !!active);

      if (!mobile){
        restoreBulkCardHome();
        bulkCardEl.classList.remove('bulk-mobile-hidden');
        return;
      }

      if (active){
        const anchor = document.getElementById('lgpMount') || bulkMobileMount || bulkCardHome;
        if (anchor && anchor.parentNode){
          const parent = anchor.parentNode;
          if (anchor.nextSibling !== bulkCardEl) {
            parent.insertBefore(bulkCardEl, anchor.nextSibling);
          }
        } else {
          const retry = Number(options.retryCount || 0);
          if (retry < 5){
            setTimeout(() => applyBulkMobileState({ retryCount: retry + 1 }), 200);
          }
        }
        bulkCardEl.classList.remove('bulk-mobile-hidden');
      } else {
        restoreBulkCardHome();
        bulkCardEl.classList.add('bulk-mobile-hidden');
      }
    }

    function updateBulkToggleUI(){
      if (bulkToggleBtn){
        bulkToggleBtn.textContent = bulkMobileEnabled ? 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø£Ø¯Ø§Ø©' : 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø©';
        bulkToggleBtn.classList.toggle('btn-danger', bulkMobileEnabled);
      }
      if (bulkToggleNote){
        if (isMobileLayout()){
          bulkToggleNote.textContent = bulkMobileEnabled
            ? 'Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ Ø£Ø³ÙÙ„ Ø²Ø± Ø§Ù„Ø³Ø¬Ù„ (20 Ù†ØªÙŠØ¬Ø© Ù„ÙƒÙ„ ØµÙØ­Ø©).'
            : 'ÙØ¹Ù‘Ù„ Ø§Ù„Ø¥Ø¸Ù‡Ø§Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ Ù‡Ù†Ø§ (20 Ù†ØªÙŠØ¬Ø© Ù„ÙƒÙ„ ØµÙØ­Ø©).';
        } else {
          bulkToggleNote.textContent = 'ÙŠÙØ¹Ø±Ø¶ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙˆØ§Ø³Ø¹Ø© (20 Ù†ØªÙŠØ¬Ø© Ù„ÙƒÙ„ ØµÙØ­Ø©).';
        }
      }
    }

    function signalBulkMobileChange(){
      document.dispatchEvent(new CustomEvent('bulk-mobile-state-change'));
    }

    function setBulkBusy(flag){
      bulkBusy = !!flag;
      const disabled = bulkBusy;
      [bulkPasteBtn, bulkAnalyzeBtn, bulkExecuteBtn, bulkCopyAllBtn, bulkCopySalaryBtn, bulkResetBtn,
        bulkScope, bulkTargetSheet, bulkRefreshSheets, bulkNewSheet, bulkCreateSheet,
        bulkExternalTargetSheet, bulkExternalRefreshSheets, bulkExternalNewSheet, bulkExternalCreateSheet,
        bulkAdminColor, bulkWithdrawColor, bulkDiscount, bulkIdsInput]
        .forEach(el => { if (el) el.disabled = disabled && el !== bulkResetBtn; });
      if (bulkResetBtn) bulkResetBtn.disabled = disabled;
    }

    function updateBulkProgress(done, total, label){
      const max = Math.max(0, Number(total) || 0);
      const cur = Math.min(max, Math.max(0, Number(done) || 0));
      const pct = max === 0 ? 0 : Math.round((cur / max) * 100);
      if (bulkProgressBar) bulkProgressBar.style.width = `${pct}%`;
      if (bulkProgressLabel) bulkProgressLabel.textContent = `${pct}%`;
      if (bulkSummaryText) bulkSummaryText.textContent = label || '';
    }

    function updateBulkButtons(){
      const hasIds = bulkIds.length > 0;
      if (bulkPasteBtn) bulkPasteBtn.disabled = bulkBusy;
      if (bulkAnalyzeBtn) bulkAnalyzeBtn.disabled = !hasIds || bulkBusy;
      if (bulkExecuteBtn) bulkExecuteBtn.disabled = !hasIds || !bulkAnalyzed || bulkBusy;
      if (bulkCopyAllBtn) bulkCopyAllBtn.disabled = !bulkExecuted || bulkBusy;
      if (bulkCopySalaryBtn) bulkCopySalaryBtn.disabled = !bulkExecuted || bulkBusy;
    }

    function renderBulkResults(){
      while (bulkResultsBody && bulkResultsBody.firstChild) {
        bulkResultsBody.removeChild(bulkResultsBody.firstChild);
      }
      if (!bulkResults.length) {
        if (bulkEmptyState) bulkEmptyState.style.display = '';
        updateBulkPaginationUI(0, 0, 0, 0);
        return;
      }
      if (bulkEmptyState) bulkEmptyState.style.display = 'none';

      const discountPct = Math.max(0, Math.min(100, Number(bulkDiscount?.value) || 0));
      const discountApplied = discountPct > 0;
      const total = bulkResults.length;
      const totalPages = Math.max(1, Math.ceil(total / BULK_PAGE_SIZE));
      if (bulkPage > totalPages) bulkPage = totalPages;
      if (bulkPage < 1) bulkPage = 1;
      const startIndex = (bulkPage - 1) * BULK_PAGE_SIZE;
      const endIndex = Math.min(total, startIndex + BULK_PAGE_SIZE);
      const visible = bulkResults.slice(startIndex, endIndex);

      visible.forEach((res, idx) => {
        const tr = document.createElement('tr');
        const baseSalaryRaw = discountApplied ? (res.salaryAfterDiscount ?? res.salary) : res.salary;
        const salaryBase = Number(baseSalaryRaw || 0);
        const absoluteIndex = startIndex + idx;
        const cells = [
          { text: String(absoluteIndex + 1) },
          { text: res.id || '' },
          { text: fmt(salaryBase) },
          { html: res.duplicateLabel ? `${res.state || ''} <span class="bulk-chip">${res.duplicateLabel}</span>` : (res.state || '') },
          { text: res.colored ? 'Ù†Ø¹Ù…' : 'Ù„Ø§' }
        ];
        cells.forEach((cell, i) => {
          const td = document.createElement('td');
          if (i === 3) td.classList.add('state-cell');
          if (cell.html) td.innerHTML = cell.html;
          else td.textContent = cell.text;
          tr.appendChild(td);
        });
        if (bulkResultsBody) bulkResultsBody.appendChild(tr);
      });
      updateBulkPaginationUI(total, startIndex, endIndex, totalPages);
    }

    function updateBulkCounters(){
      const discountPct = Math.max(0, Math.min(100, Number(bulkDiscount?.value) || 0));
      const discountApplied = discountPct > 0;
      let total = bulkIds.length;
      let colored = 0;
      let salarySum = 0;
      bulkResults.forEach(res => {
        if (res.colored) colored++;
        const baseSalaryRaw = discountApplied ? (res.salaryAfterDiscount ?? res.salary) : res.salary;
        const val = Number(baseSalaryRaw || 0);
        salarySum += isNaN(val) ? 0 : val;
      });
      const uncolored = Math.max(0, total - colored);
      if (bulkCountTotal) bulkCountTotal.textContent = total;
      if (bulkCountColored) bulkCountColored.textContent = colored;
      if (bulkCountUncolored) bulkCountUncolored.textContent = uncolored;
      if (bulkSalarySum) bulkSalarySum.textContent = fmt(salarySum);
    }

    function cancelBulkAutoAnalyze(){
      if (bulkAutoAnalyzeTimer) {
        clearTimeout(bulkAutoAnalyzeTimer);
        bulkAutoAnalyzeTimer = null;
      }
    }

    function scheduleBulkAutoAnalyze(reason){
      if (!bulkIds.length) return;
      cancelBulkAutoAnalyze();
      const attempt = () => {
        if (bulkBusy) {
          bulkAutoAnalyzeTimer = setTimeout(attempt, 180);
          return;
        }
        bulkAutoAnalyzeTimer = null;
        runBulkAnalyze({ skipHandleChange: true, reason: reason || 'auto' });
      };
      if (bulkStatusText) bulkStatusText.textContent = 'â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠâ€¦';
      bulkAutoAnalyzeTimer = setTimeout(attempt, 180);
    }

    function handleBulkIdsChange(options = {}){
      const auto = options.auto !== false;
      bulkIds = parseBulkIds(bulkIdsInput?.value || '');
      bulkPage = 1;
      cancelBulkAutoAnalyze();
      if (!bulkIds.length) {
        bulkResults = [];
        bulkAnalyzed = false;
        bulkExecuted = false;
        renderBulkResults();
        updateBulkCounters();
        updateBulkButtons();
        updateBulkProgress(0, 1, '');
        if (bulkEmptyState) bulkEmptyState.style.display = '';
        if (bulkStatusText) bulkStatusText.textContent = 'Ø£Ù„ØµÙ‚ IDs ÙˆØ³ÙŠØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.';
        return;
      }
      bulkResults = [];
      bulkAnalyzed = false;
      bulkExecuted = false;
      renderBulkResults();
      updateBulkCounters();
      updateBulkButtons();
      updateBulkProgress(0, bulkIds.length, '');
      if (bulkEmptyState) bulkEmptyState.style.display = 'none';
      if (bulkStatusText) bulkStatusText.textContent = `ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${bulkIds.length} ID â€” Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù„ÙŠÙ„â€¦`;
      if (auto) scheduleBulkAutoAnalyze(options.reason || 'ids-change');
    }

    async function refreshBulkSheets(preserveLocal, preserveExternal){
      try {
        const res = await runServer('getBulkSheetLists');
        if (!res || res.ok === false) {
          if (bulkStatusText) bulkStatusText.textContent = `Ø®Ø·Ø£: ${res?.message || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚'}`;
          return;
        }

        const localList = Array.isArray(res.localSheets) ? res.localSheets : [];
        if (bulkTargetSheet) {
          const current = preserveLocal || bulkTargetSheet.value;
          bulkTargetSheet.innerHTML = '';
          localList.forEach(name => {
            const opt = document.createElement('option');
            opt.value = opt.textContent = name;
            bulkTargetSheet.appendChild(opt);
          });
          if (current && localList.includes(current)) {
            bulkTargetSheet.value = current;
          } else if (res.localDefault && localList.includes(res.localDefault)) {
            bulkTargetSheet.value = res.localDefault;
          }
        }

        const externalList = Array.isArray(res.externalSheets) ? res.externalSheets : [];
        bulkExternalAvailable = !!res.externalEnabled;
        bulkExternalDefaultName = String(res.externalDefault || '');
        bulkExternalErrorMessage = String(res.externalError || '');
        if (bulkExternalTargetSheet) {
          const currentExt = preserveExternal || bulkExternalTargetSheet.value;
          bulkExternalTargetSheet.innerHTML = '';
          externalList.forEach(name => {
            const opt = document.createElement('option');
            opt.value = opt.textContent = name;
            bulkExternalTargetSheet.appendChild(opt);
          });
          if (currentExt && externalList.includes(currentExt)) {
            bulkExternalTargetSheet.value = currentExt;
          } else if (bulkExternalDefaultName && externalList.includes(bulkExternalDefaultName)) {
            bulkExternalTargetSheet.value = bulkExternalDefaultName;
          } else if (externalList.length) {
            bulkExternalTargetSheet.value = externalList[0];
          }
        }

        if (bulkExternalFileLabel) {
          bulkExternalFileLabel.textContent = res.externalFileName ? `(${res.externalFileName})` : '';
        }

        applyBulkScopeUI();
      } catch (err) {
        if (bulkStatusText) bulkStatusText.textContent = `Ø®Ø·Ø£: ${err?.message || err}`;
      }
    }

    async function createBulkSheet(){
      const name = (bulkNewSheet?.value || '').trim();
      if (!name) {
        if (bulkStatusText) bulkStatusText.textContent = 'âš ï¸ Ø§ÙƒØªØ¨ Ø§Ø³Ù… ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø£ÙˆÙ„Ù‹Ø§.';
        return;
      }
      const btn = bulkCreateSheet;
      if (btn) btn.disabled = true;
      try {
        const res = await runServer('createSheetIfMissing', name);
        await refreshBulkSheets(res?.name || name, bulkExternalTargetSheet?.value);
        bulkNewSheet.value = '';
        if (bulkStatusText) bulkStatusText.textContent = `âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙˆØ±Ù‚Ø©: ${res?.name || name}`;
      } catch (err) {
        if (bulkStatusText) bulkStatusText.textContent = `Ø®Ø·Ø£: ${err?.message || err}`;
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    async function createExternalSheet(){
      const name = (bulkExternalNewSheet?.value || '').trim();
      if (!name) {
        if (bulkExternalNote) bulkExternalNote.textContent = 'âš ï¸ Ø§ÙƒØªØ¨ Ø§Ø³Ù… ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø£ÙˆÙ„Ù‹Ø§.';
        return;
      }
      const btn = bulkExternalCreateSheet;
      if (btn) btn.disabled = true;
      try {
        const res = await runServer('createExternalSheetIfMissing', name);
        await refreshBulkSheets(bulkTargetSheet?.value, res?.name || name);
        if (bulkExternalNewSheet) bulkExternalNewSheet.value = '';
        if (bulkExternalNote) bulkExternalNote.textContent = `âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©: ${res?.name || name}`;
      } catch (err) {
        if (bulkExternalNote) bulkExternalNote.textContent = `Ø®Ø·Ø£: ${err?.message || err}`;
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    function applyBulkScopeUI(){
      const scope = bulkScope?.value || 'both';
      const showExternal = scope === 'all';
      if (bulkExternalWrap) {
        bulkExternalWrap.style.display = showExternal ? '' : 'none';
      }
      if (bulkExternalNote) {
        if (showExternal && !bulkExternalAvailable) {
          bulkExternalNote.textContent = bulkExternalErrorMessage || 'âš ï¸ Ø£Ø¶Ù Ø±Ø§Ø¨Ø· Ù…Ù„Ù Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ ÙÙŠ Settings (Ø§Ù„Ø¹Ù…ÙˆØ¯ I).';
        } else if (showExternal && bulkExternalErrorMessage) {
          bulkExternalNote.textContent = bulkExternalErrorMessage;
        } else {
          bulkExternalNote.textContent = '';
        }
      }
      if (showExternal && bulkExternalAvailable && bulkExternalTargetSheet && !bulkExternalTargetSheet.value && bulkExternalDefaultName) {
        const opts = Array.from(bulkExternalTargetSheet.options || []);
        const match = opts.find(o => o.value === bulkExternalDefaultName);
        if (match) bulkExternalTargetSheet.value = bulkExternalDefaultName;
      }
    }

    async function runBulkAnalyze(options = {}){
      if (bulkBusy) return;
      if (!options.skipHandleChange) handleBulkIdsChange({ auto: false, reason: options.reason });
      if (!bulkIds.length) {
        if (bulkStatusText) bulkStatusText.textContent = 'âš ï¸ Ø£Ø¶Ù IDs Ø£ÙˆÙ„Ù‹Ø§.';
        return;
      }
      cancelBulkAutoAnalyze();
      const discountVal = Math.max(0, Math.min(100, Number(bulkDiscount?.value) || 0));
      const scope = bulkScope?.value || 'both';
      setBulkBusy(true);
      bulkResults = [];
      bulkAnalyzed = false;
      bulkExecuted = false;
      renderBulkResults();
      updateBulkCounters();
      updateBulkButtons();
      updateBulkProgress(0, bulkIds.length, 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù„ÙŠÙ„â€¦');
      if (bulkStatusText) bulkStatusText.textContent = 'â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù„ÙŠÙ„â€¦';

      const chunkSize = bulkIds.length > 400 ? 150 : 120;
      let processed = 0;
      const aggregated = [];

      try {
        for (let i = 0; i < bulkIds.length; i += chunkSize) {
          const part = bulkIds.slice(i, i + chunkSize);
          const res = await runServer('bulkSearchExact', part, discountVal, scope);
          if (!res || !res.ok) {
            throw new Error(res?.message || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„');
          }
          const arr = Array.isArray(res.results) ? res.results : [];
          aggregated.push(...arr);
          processed += part.length;
          updateBulkProgress(processed, bulkIds.length, `ØªÙ… ØªØ­Ù„ÙŠÙ„ ${Math.min(processed, bulkIds.length)} Ù…Ù† ${bulkIds.length}`);
        }
        bulkPage = 1;
        bulkResults = aggregated;
        bulkAnalyzed = true;
        bulkExecuted = false;
        renderBulkResults();
        updateBulkCounters();
        updateBulkButtons();
        updateBulkProgress(bulkIds.length, bulkIds.length, 'ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„');
        if (bulkStatusText) bulkStatusText.textContent = `âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„ ${bulkResults.length} ID.`;
      } catch (err) {
        if (bulkStatusText) bulkStatusText.textContent = `Ø®Ø·Ø£: ${err?.message || err}`;
        updateBulkProgress(processed, bulkIds.length, 'ØªÙˆÙ‚Ù Ø¨Ø³Ø¨Ø¨ Ø®Ø·Ø£');
      } finally {
        setBulkBusy(false);
        updateBulkButtons();
      }
    }

    async function runBulkExecute(){
      if (bulkBusy) {
        if (bulkStatusText) bulkStatusText.textContent = 'â³ Ù‡Ù†Ø§Ùƒ Ø¹Ù…Ù„ÙŠØ© Ø¬Ø§Ø±ÙŠØ©ØŒ Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ù‹Ø§.';
        return;
      }
      if (!bulkIds.length) {
        if (bulkStatusText) bulkStatusText.textContent = 'âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ IDs.';
        return;
      }
      if (!bulkAnalyzed) {
        await runBulkAnalyze({ skipHandleChange: true, reason: 'execute' });
        if (!bulkAnalyzed) {
          if (bulkStatusText) bulkStatusText.textContent = 'âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°.';
          return;
        }
      }

      const ids = bulkIds.slice();
      if (!ids.length) {
        if (bulkStatusText) bulkStatusText.textContent = 'âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ IDs.';
        return;
      }

      const scope = bulkScope?.value || 'both';
      const targetMode = scope === 'agent' ? 'agent' : 'both';
      const sheetName = bulkTargetSheet?.value || '';
      if (targetMode !== 'agent' && !sheetName) {
        if (bulkStatusText) bulkStatusText.textContent = 'âš ï¸ Ø§Ø®ØªØ± ÙˆØ±Ù‚Ø© Ø§Ù„Ù‡Ø¯Ù.';
        return;
      }

      let externalSheetName = '';
      if (scope === 'all') {
        if (!bulkExternalAvailable) {
          if (bulkExternalNote) bulkExternalNote.textContent = bulkExternalErrorMessage || 'âš ï¸ Ø£Ø¶Ù Ù…Ù„Ù Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ø£ÙˆÙ„Ù‹Ø§.';
        }
        externalSheetName = bulkExternalTargetSheet?.value || '';
      }

      const config = {
        sheetName: sheetName,
        color: bulkWithdrawColor?.value || '#ddd6fe',
        adminColor: bulkAdminColor?.value || '#fde68a',
        withdrawColor: bulkWithdrawColor?.value || '#ddd6fe',
        targetMode: targetMode,
        scope: scope,
        externalSheetName: externalSheetName
      };

      cancelBulkAutoAnalyze();
      setBulkBusy(true);
      bulkExecuted = false;
      updateBulkButtons();
      updateBulkProgress(0, ids.length, 'Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ†ÙÙŠØ°â€¦');
      if (bulkStatusText) bulkStatusText.textContent = 'â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ†ÙÙŠØ°â€¦';

      const chunkSize = ids.length > 300 ? 80 : 60;
      let processed = 0;
      let copiedTotal = 0;
      let skippedTotal = 0;
      let copiedExternalTotal = 0;
      const coloredSet = new Set();

      try {
        for (let i = 0; i < ids.length; i += chunkSize) {
          const part = ids.slice(i, i + chunkSize);
          const res = await runServer('bulkExecuteExact', part, config);
          if (!res || !res.ok) {
            throw new Error(res?.message || 'ÙØ´Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°');
          }
          const newlyColored = Array.isArray(res.coloredIds) ? res.coloredIds : [];
          newlyColored.forEach(id => coloredSet.add(id));
          if (newlyColored.length) {
            markJustColored(newlyColored, targetMode);
            if (localMap) {
              newlyColored.forEach(uid => {
                const key = String(uid || '').trim();
                if (!key || !localMap[key]) return;
                localMap[key].aCol = true;
                if (targetMode === 'both') localMap[key].dCol = true;
              });
            }
          }
          copiedTotal += Number(res.copied || 0);
          skippedTotal += Number(res.skipped || 0);
          copiedExternalTotal += Number(res.copiedExternal || 0);
          processed += part.length;
          updateBulkProgress(processed, ids.length, `ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© ${Math.min(processed, ids.length)} Ù…Ù† ${ids.length}`);
        }

        if (coloredSet.size) {
          bulkResults = bulkResults.map(res => coloredSet.has(res.id)
            ? Object.assign({}, res, { colored: true })
            : res);
        }
        if (coloredSet.size) {
          markJustColored(Array.from(coloredSet), targetMode);
        }
        bulkExecuted = true;
        renderBulkResults();
        updateBulkCounters();
        updateBulkButtons();
        updateBulkProgress(ids.length, ids.length, 'ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°');
        const parts = ['âœ… ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°'];
        if (coloredSet.size) parts.push(`ØªÙ„ÙˆÙŠÙ† ${coloredSet.size}`);
        if (copiedTotal) parts.push(`Ù†Ø³Ø® ${copiedTotal}`);
        if (copiedExternalTotal) parts.push(`Ø®Ø§Ø±Ø¬ÙŠ ${copiedExternalTotal}`);
        if (skippedTotal) parts.push(`ØªØ®Ø·ÙŠ ${skippedTotal}`);
        if (bulkStatusText) bulkStatusText.textContent = parts.join(' â€¢ ');
      } catch (err) {
        if (bulkStatusText) bulkStatusText.textContent = `Ø®Ø·Ø£: ${err?.message || err}`;
        updateBulkProgress(processed, ids.length, 'ØªÙˆÙ‚Ù Ø¨Ø³Ø¨Ø¨ Ø®Ø·Ø£');
      } finally {
        setBulkBusy(false);
        updateBulkButtons();
      }
    }

    async function copyBulk(mode){
      if (!bulkExecuted || !bulkResults.length) {
        if (bulkStatusText) bulkStatusText.textContent = 'âš ï¸ Ù†ÙÙ‘Ø° Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£ÙˆÙ„Ù‹Ø§.';
        return;
      }
      const discountPct = Math.max(0, Math.min(100, Number(bulkDiscount?.value) || 0));
      const discountApplied = discountPct > 0;
      const rows = bulkResults.map(res => {
        const baseSalaryRaw = discountApplied ? (res.salaryAfterDiscount ?? res.salary) : res.salary;
        const salaryVal = Number(baseSalaryRaw || 0);
        const salaryStr = salaryVal.toFixed(2);
        if (mode === 'salary') return salaryStr;
        return [res.id || '', salaryStr, res.state || ''].join('\t');
      });
      const text = rows.join('\n');
      try {
        await navigator.clipboard.writeText(text);
        if (bulkStatusText) bulkStatusText.textContent = 'âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.';
      } catch (err) {
        const helper = document.createElement('textarea');
        helper.style.position = 'fixed';
        helper.style.opacity = '0';
        helper.value = text;
        document.body.appendChild(helper);
        helper.focus();
        helper.select();
        try {
          document.execCommand('copy');
          if (bulkStatusText) bulkStatusText.textContent = 'âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø® (ÙˆØ¶Ø¹ Ø§Ø­ØªÙŠØ§Ø·ÙŠ).';
        } catch (e2) {
          if (bulkStatusText) bulkStatusText.textContent = `âš ï¸ Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§: ${e2?.message || e2}`;
        }
        document.body.removeChild(helper);
      }
    }

    function resetBulkTool(){
      if (bulkBusy) return;
      cancelBulkAutoAnalyze();
      if (bulkIdsInput) bulkIdsInput.value = '';
      bulkIds = [];
      bulkResults = [];
      bulkAnalyzed = false;
      bulkExecuted = false;
      bulkPage = 1;
      renderBulkResults();
      updateBulkCounters();
      updateBulkButtons();
      updateBulkProgress(0, 1, '');
      if (bulkEmptyState) bulkEmptyState.style.display = '';
      if (bulkStatusText) bulkStatusText.textContent = 'ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†.';
    }

    async function handleBulkPaste(){
      try {
        const txt = await navigator.clipboard.readText();
        if (txt && txt.trim()) {
          if (bulkIdsInput) bulkIdsInput.value = txt.trim();
          handleBulkIdsChange({ auto: true, reason: 'paste' });
          return;
        }
      } catch (_) {}
      const fallback = prompt('Ø£Ù„ØµÙ‚ IDs ÙŠØ¯ÙˆÙŠÙ‹Ø§:');
      if (fallback && bulkIdsInput) {
        bulkIdsInput.value = fallback;
        handleBulkIdsChange({ auto: true, reason: 'paste' });
      }
    }

    /******** Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¥Ø®ÙØ§Ø¡/ØªØ¹Ø·ÙŠÙ„) ********/
    function isPersonFeatureDisabled(){ return localStorage.getItem('disable_person_feature') === '1'; }
    function isPersonHidden(){ return localStorage.getItem('hide_person_section') === '1'; }

    function applyPersonVisibility(){
      const disabled = isPersonFeatureDisabled();
      const hidden = isPersonHidden() || disabled;
      if (qtDisablePerson) qtDisablePerson.checked = disabled;
      if (personCardEl) personCardEl.style.display = hidden ? 'none' : '';
      bodyEl.classList.toggle('data-active', !hidden);
      if (disabled){
        personMsg.value = '';
        personNote.textContent = 'â€”';
      }
      copyMsgBtn.disabled = disabled;
      colorAllBtn.disabled = disabled;
      if (qtHidePerson) qtHidePerson.textContent = hidden ? 'ØªÙØ¹ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' : 'Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    }
    if (qtHidePerson) qtHidePerson.addEventListener('click', ()=>{
      if (isPersonFeatureDisabled()) localStorage.setItem('disable_person_feature', '0');
      const cur = isPersonHidden();
      localStorage.setItem('hide_person_section', cur ? '0':'1');
      applyPersonVisibility();
      if (menuOverlay) closeMenu();
    });
    if (qtDisablePerson) qtDisablePerson.addEventListener('change', ()=>{
      const en = !!qtDisablePerson.checked;
      localStorage.setItem('disable_person_feature', en ? '1':'0');
      applyPersonVisibility();
    });

    /******** Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© UI ********/
    function flash(el, cls){
      el.classList.remove('flash-blue','flash-green');
      void el.offsetWidth;
      el.classList.add(cls);
    }
    function saveLastId(id){
      try { localStorage.setItem('last_id', id); } catch(_){}
      lastIdText.textContent = id || '';
      lastIdPill.style.display = id ? 'inline-flex' : 'none';
    }
    function loadLastId(){
      let v = '';
      try { v = localStorage.getItem('last_id') || ''; } catch(_){}
      if (v){ lastIdText.textContent = v; lastIdPill.style.display = 'inline-flex'; }
      else { lastIdPill.style.display = 'none'; }
    }
    lastIdPill.addEventListener('click', ()=>{
      const v = lastIdText.textContent || '';
      if (!v) return;
      idInput.value = v;
      doSearch();
    });

    /******** ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ********/
    function fillSheets(){
      google.script.run
        .withSuccessHandler(arr=>{
          const list = Array.isArray(arr) ? arr : [];
          sheetSelect.innerHTML = '';
          list.forEach(n=>{
            const o = document.createElement('option');
            o.value = o.textContent = n;
            sheetSelect.appendChild(o);
          });
          if (bulkTargetSheet) {
            const keep = bulkTargetSheet.value;
            refreshBulkSheets(keep, bulkExternalTargetSheet?.value);
          }
        })
        .withFailureHandler(err=> advNote.textContent = 'Ø®Ø·Ø£: '+(err?.message||''))
        .getAdminSheets();
    }

    /******** ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ********/
    function setLoadBtnState(ok){
      if (reloadBtn){
        reloadBtn.classList.remove('load-btn--ok','load-btn--error');
        if (ok === true) reloadBtn.classList.add('load-btn--ok');
        else if (ok === false) reloadBtn.classList.add('load-btn--error');
      }
      if (reloadBtnMenu){
        reloadBtnMenu.classList.remove('menu-btn--ok','menu-btn--error');
        if (ok === true) reloadBtnMenu.classList.add('menu-btn--ok');
        else if (ok === false) reloadBtnMenu.classList.add('menu-btn--error');
      }
    }
    function loadData(){
      setLoadBtnState(false);
      setLoadNote('â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦');
      google.script.run
        .withSuccessHandler(srv=>{
          const baseMsg = srv?.message || 'ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.';
          google.script.run
            .withSuccessHandler(res=>{
              if(!res || !res.ok){
                setLoadNote(baseMsg + ' | âš ï¸ ÙØ´Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ: ' + (res?.message||''));
                setLoadBtnState(false);
                return;
              }
              localMap = res.map || null;
              const st = res.stats || {};
              setLoadNote(`${baseMsg} | Ù…Ø­Ù„ÙŠ: ${st.agentRows||0} ØµÙ / ${st.agentUnique||0} ID.`);
              setLoadBtnState(true);
              refreshCountsLive();
            })
            .withFailureHandler(err=>{
              setLoadNote(baseMsg + ' | âš ï¸ Ø®Ø·Ø£ Ø¨Ø§Ù„Ù…Ø­Ù„ÙŠ: ' + (err?.message||''));
              setLoadBtnState(false);
            })
            .getSearchSnapshotLight();
        })
        .withFailureHandler(err=>{
          setLoadNote('âš ï¸ Ø®Ø·Ø£ Ø¨Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + (err?.message||''));
          setLoadBtnState(false);
        })
        .loadDataIntoCache();
    }
    if (reloadBtn) reloadBtn.addEventListener('click', ()=>{ closeMenu(); loadData(); });
    if (reloadBtnMenu) reloadBtnMenu.addEventListener('click', ()=>{
      closeMenu();
      if (reloadBtn) reloadBtn.click();
      else loadData();
    });
    reloadBtn.addEventListener('click', ()=>{ closeMenu(); loadData(); });
    createSheetBtn.addEventListener('click', ()=>{
  const name = (newSheetName.value || '').trim();
  if (!name){ advNote.textContent = 'âš ï¸ Ø§ÙƒØªØ¨ Ø§Ø³Ù… ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©'; return; }
  google.script.run
    .withSuccessHandler(msg=>{
      advNote.textContent = msg || 'ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ âœ…';
      // Ø­Ø¯Ù‘Ø« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ­Ø¯Ù‘Ø¯ Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      google.script.run
        .withSuccessHandler(arr=>{
          sheetSelect.innerHTML = '';
          (arr||[]).forEach(n=>{
            const o = document.createElement('option');
            o.value = o.textContent = n;
            sheetSelect.appendChild(o);
          });
          // Ø­Ø§ÙˆÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„ØªÙŠ Ø£Ù†Ø´Ø£Ù†Ø§Ù‡Ø§
          const opt = Array.from(sheetSelect.options).find(o => o.value === name);
          if (opt) sheetSelect.value = name;
          newSheetName.value = '';
        })
        .getAdminSheets();
    })
    .withFailureHandler(err=>{
      advNote.textContent = 'Ø®Ø·Ø£: ' + (err?.message || '');
    })
    .createAdminSheet(name);
    });

    if (bulkIdsInput) bulkIdsInput.addEventListener('input', () => handleBulkIdsChange({ reason: 'typing' }));
    if (bulkPasteBtn) bulkPasteBtn.addEventListener('click', handleBulkPaste);
    if (bulkAnalyzeBtn) bulkAnalyzeBtn.addEventListener('click', () => runBulkAnalyze({ reason: 'manual-button' }));
    if (bulkExecuteBtn) bulkExecuteBtn.addEventListener('click', runBulkExecute);
    if (bulkCopyAllBtn) bulkCopyAllBtn.addEventListener('click', () => copyBulk('all'));
    if (bulkCopySalaryBtn) bulkCopySalaryBtn.addEventListener('click', () => copyBulk('salary'));
    if (bulkResetBtn) bulkResetBtn.addEventListener('click', resetBulkTool);
    if (bulkPrevBtn) bulkPrevBtn.addEventListener('click', () => {
      if (bulkPage > 1) {
        bulkPage--;
        renderBulkResults();
      }
    });
    if (bulkNextBtn) bulkNextBtn.addEventListener('click', () => {
      const totalPages = Math.max(1, Math.ceil((bulkResults.length || 0) / BULK_PAGE_SIZE));
      if (bulkPage < totalPages) {
        bulkPage++;
        renderBulkResults();
      }
    });
    if (bulkDiscount) bulkDiscount.addEventListener('input', () => {
      if (!bulkIds.length) return;
      bulkAnalyzed = false;
      bulkExecuted = false;
      updateBulkButtons();
      if (bulkStatusText) bulkStatusText.textContent = 'â³ Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®ØµÙ…â€¦';
      scheduleBulkAutoAnalyze('discount-change');
    });
    if (bulkRefreshSheets) bulkRefreshSheets.addEventListener('click', () => refreshBulkSheets(bulkTargetSheet?.value, bulkExternalTargetSheet?.value));
    if (bulkExternalRefreshSheets) bulkExternalRefreshSheets.addEventListener('click', () => refreshBulkSheets(bulkTargetSheet?.value, bulkExternalTargetSheet?.value));
    if (bulkCreateSheet) bulkCreateSheet.addEventListener('click', createBulkSheet);
    if (bulkExternalCreateSheet) bulkExternalCreateSheet.addEventListener('click', createExternalSheet);
    if (bulkScope) bulkScope.addEventListener('change', () => {
      bulkAnalyzed = false;
      bulkExecuted = false;
      applyBulkScopeUI();
      updateBulkButtons();
      if (bulkIds.length) scheduleBulkAutoAnalyze('scope-change');
    });
    if (bulkToggleBtn) bulkToggleBtn.addEventListener('click', () => {
      bulkMobileEnabled = !bulkMobileEnabled;
      try { localStorage.setItem(BULK_MOBILE_STORAGE_KEY, bulkMobileEnabled ? '1' : '0'); } catch (_) {}
      updateBulkToggleUI();
      applyBulkMobileState();
      signalBulkMobileChange();
    });

    window.addEventListener('resize', () => {
      updateBulkToggleUI();
      applyBulkMobileState();
      signalBulkMobileChange();
    });

    updateBulkToggleUI();
    applyBulkMobileState();
    setTimeout(signalBulkMobileChange, 0);

    refreshBulkSheets();
    applyBulkScopeUI();
    updateBulkButtons();

    /******** Ù„ØµÙ‚ Ø«Ù… Ø¨Ø­Ø« / Ø¥Ù†ØªØ± ********/
    pasteSearchBtn.addEventListener('click', async ()=>{
      pasteHint.textContent = '';
      try{
        const txt = await navigator.clipboard.readText();
        if (txt && txt.trim()){
          idInput.value = txt.trim();
          doSearch();
          return;
        }
      }catch(_){}
      idInput.focus(); idInput.select();
      pasteHint.textContent = 'Ø§Ù„ØµÙ‚ ÙŠØ¯ÙˆÙŠÙ‹Ø§ ÙˆØ³ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§â€¦';
      const once = ()=>{ pasteHint.textContent = ''; idInput.removeEventListener('input', once); setTimeout(doSearch, 0); };
      idInput.addEventListener('input', once, { once:true });
    });
    idInput.addEventListener('paste', ()=> setTimeout(doSearch, 0));
    idInput.addEventListener('keyup', e=>{ if (e.key === 'Enter') doSearch(); });

    /******** Ø±Ù†Ø¯Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ********/
    function clearDupUI(){
      dupBadge.style.display = 'none';
      dupBadge.textContent = 'Ù…ÙƒØ±Ø±';
      dupBadge.className = 'status-pill status-pill--dup';
      extraDupInfo.textContent = '';
    }
    function renderLoading(){
      clearDupUI();
      statusBadge.className = 'status-pill status-pill--loading';
      statusBadge.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø«â€¦';
      amountText.textContent = 'â³';
      multiText.textContent = '';
      if (nameText) nameText.textContent = 'â€”';
      clearAdvNote();
    }
    function applyBadges(baseStatus, duplicateLabel, hasSalaries){
      const baseClass = resolveStatusClass(baseStatus);
      statusBadge.className = 'status-pill ' + baseClass;
      statusBadge.textContent = baseStatus || 'â€”';
      if (duplicateLabel){ dupBadge.style.display='inline-block'; dupBadge.textContent=duplicateLabel; }
      else dupBadge.style.display='none';
    }
    function renderResult(res){
      lastResult = res;
      
      // Ø­Ø¯Ù‘Ø¯ Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ø¥Ù† ÙˆØ¬Ø¯ ÙÙ‰ Ø§Ù„Ù†ØªÙŠØ¬Ø© (Ø¥Ù…Ø§ Ø®Ø§ØµÙŠØ© name Ø£Ùˆ Ø¯Ù…Ø¬ Ù…ØµÙÙˆÙØ© names)
      (function(){ 
        try{
          let nm = '';
          if (res) {
            if (res.name) nm = String(res.name||'').trim();
            else if (Array.isArray(res.names)) nm = res.names.map(x=>String(x||'').trim()).filter(Boolean).join('ØŒ ');
          }
          if (nameText) nameText.textContent = nm || 'â€”';
        }catch(_){ if (nameText) nameText.textContent = 'â€”'; }
      })();
if (res.status === 'error'){ applyBadges('Ø®Ø·Ø£', null, false); amountText.textContent='â€”'; multiText.textContent=res.message||''; return; }
      if (res.status === 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'){ applyBadges('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', null, false); amountText.textContent='â€”'; multiText.textContent=''; return; }

      const baseStatus = res.status || '';
      const dupLabel   = (res.isDuplicate && res.duplicateLabel) ? res.duplicateLabel : null;

      const hasSalaries = Array.isArray(res.salaries) && res.salaries.length > 0;
      const isAdminOnly = baseStatus.includes('Ø§Ø¯Ø§Ø±Ø©') && !hasSalaries;

      applyBadges(baseStatus, dupLabel, hasSalaries);

      if (isAdminOnly){ amountText.textContent='â€”'; multiText.textContent=''; flash(resultsBox,'flash-blue'); return; }

      const total = Number(res.totalSalary)||0;
      const pct   = Math.max(0, Math.min(100, Number(discountInput.value)||0));
      amountText.textContent = fmt(total * (1 - pct/100));

      if (hasSalaries && res.salaries.length > 1){
        multiText.textContent = '(' + res.salaries.map(n=>fmt(Number(n)||0)).join(' + ') + ')';
      } else multiText.textContent = '';

      flash(resultsBox,'flash-blue');
    }

    /******** Ø§Ù„Ø±Ø³Ø§Ù„Ø© ********/
    function buildMessageText(card, applyDiscount, localMapRef){
      if (!card || !Array.isArray(card.ids)) return 'â€”';
      const pct = Math.max(0, Math.min(100, Number(discountInput.value)||0));
      const lm  = localMapRef || {};
      const header = [];
      if (card.name)    header.push(card.name);
      if (card.phone)   header.push(card.phone);
      if (card.address) header.push(card.address);
      if (card.agency)  header.push(card.agency);
      if (card.note)    header.push('Ù…Ù„Ø§Ø­Ø¸Ø© : ' + card.note);

      let total = 0;
      const idLines = [];
      card.ids.forEach(x=>{
        const id = String(x.id||'').trim();
        if (!id) return;
        const node = lm[id];
        const adminOnly = node ? (!node.rowsCount && node.inAdmin) : false;
        let val = Number(x.amount||0);
        if (applyDiscount) val = val * (pct ? (1 - pct/100) : 1);
        total += val;
        idLines.push({ id, text: `${id} ... ${fmt(val)}${adminOnly ? ' Ø§Ø¯Ø§Ø±Ø©' : ''}`, value: val });
      });

      const lines = [];
      lines.push(header.join('\n')); lines.push('');
      if (idLines.length === 1){
        lines.push(idLines[0].id); lines.push(''); lines.push(fmt(idLines[0].value));
      } else if (idLines.length > 1){
        lines.push(idLines.map(x=>x.text).join('\n'));
        lines.push('â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢');
        lines.push('Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ : ' + fmt(total));
        lines.push('â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢');
      }
      return lines.filter(Boolean).join('\n');
    }

    function renderPersonCard(id){
      if (isPersonFeatureDisabled()) { personNote.textContent='â€”'; personMsg.value=''; return; }
      personNote.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©...';
      personMsg.value = '';
      lastProfileIds = [];
      google.script.run
        .withSuccessHandler(card=>{
          if(!card || !card.ok){
            personNote.textContent = card?.message || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª.';
            personMsg.value = '';
            return;
          }
          lastProfileIds = (card.ids||[]).map(x=> String(x.id));
          const txt = buildMessageText(card, applyDiscountToMessage.checked, localMap);
          personMsg.value = txt;
          personNote.textContent = `ØªÙ… â€” Ø¹Ø¯Ø¯ IDs: ${lastProfileIds.length}`;
          flash(personCardEl, 'flash-blue');

          clearDupUI();
          const dupList = [];
          lastProfileIds.forEach(uid=>{
            const node = localMap && localMap[uid];
            if (!node) return;
            if (node.aCol && node.dCol) dupList.push(`${uid} (Ù…ÙƒØ±Ø±)`);
            else if (node.aCol)         dupList.push(`${uid} (Ù…ÙƒØ±Ø± ÙˆÙƒØ§Ù„Ø© ÙÙ‚Ø·)`);
            else if (node.dCol)         dupList.push(`${uid} (Ù…ÙƒØ±Ø± Ø§Ø¯Ø§Ø±Ø© ÙÙ‚Ø·)`);
          });
          if (dupList.length){
            dupBadge.style.display='inline-block';
            dupBadge.textContent='Ù…ÙƒØ±Ø±';
            extraDupInfo.textContent = 'IDs Ù…ÙƒØ±Ø±Ø©: ' + dupList.join('ØŒ ');
          }
        })
        .withFailureHandler(err=>{
          personNote.textContent = 'Ø®Ø·Ø£: ' + (err?.message||'');
          personMsg.value = '';
        })
        .getPersonCardById(id);
    }

    function rebuildPersonCardUsingLast(){
      if (isPersonFeatureDisabled()) return;
      if (lastBaseId){
        google.script.run
          .withSuccessHandler(card=>{
            if(card && card.ok){
              personMsg.value = buildMessageText(card, !!applyDiscountToMessage.checked, localMap);
              personNote.textContent = `ØªÙ… â€” Ø¹Ø¯Ø¯ IDs: ${(card.ids||[]).length}`;
            }
          })
          .getPersonCardById(lastBaseId);
      }
    }

    copyMsgBtn.addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(personMsg.value||'');
        copyMsgBtn.textContent = 'âœ“ Ù†ÙØ³Ø®Øª';
        setTimeout(()=> copyMsgBtn.textContent='Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 900);
      }catch(_){
        personMsg.select(); document.execCommand('copy');
      }
    });

    colorAllBtn.addEventListener('click', ()=>{
      if (isPersonFeatureDisabled()) { personNote.textContent='Ø§Ù„Ù…ÙŠØ²Ø© Ù…Ø¹Ø·Ù‘Ù„Ø©.'; return; }
      if (!lastProfileIds.length){ personNote.textContent='Ù„Ø§ IDs Ù„ØªÙ„ÙˆÙŠÙ†Ù‡Ø§.'; return; }
      const sheet = sheetSelect.value;
      const targetMode = targetModeSel.value;
      if (targetMode==='both' && !sheet){ advNote.textContent='Ø§Ø®ØªØ± ÙˆØ±Ù‚Ø© Ø§Ù„Ù‡Ø¯Ù Ø£ÙˆÙ„Ø§Ù‹.'; return; }

      personNote.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ„ÙˆÙŠÙ†...';
      let done=0, fail=0;
      const runOne = (uid)=> new Promise((resolve)=>{
        google.script.run
          .withSuccessHandler(_=>{ done++; resolve(true); })
          .withFailureHandler(_=>{ fail++; resolve(false); })
          .applyAdvancedAction(uid, sheet, adminColor.value, withdrawColor.value, targetMode);
      });
      Promise.all(lastProfileIds.map(runOne)).then(()=>{
        personNote.textContent = `ØªÙ… â€” Ù…Ù„ÙˆÙ‘Ù†: ${done}, ÙØ´Ù„: ${fail}`;
        flash(personCardEl,'flash-green');
        if(localMap){
          lastProfileIds.forEach(uid=>{
            if(!localMap[uid]) return;
            localMap[uid].aCol = true;
            if (targetMode==='both') localMap[uid].dCol = true;
          });
        }
        markJustColored(lastProfileIds, targetMode);
        refreshCountsLive();
      });
    });

    /******** ØªÙ†ÙÙŠØ° Ø°ÙƒÙŠ ********/
    function runAdvanced() {
      clearAdvNote();
      advNote.textContent = '... Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ†ÙÙŠØ°';
      const id = idInput.value.trim();
      if (!id) { advNote.textContent = 'âš ï¸ Ø£Ø¯Ø®Ù„ ID Ø£ÙˆÙ„Ø§Ù‹'; return; }

      const sheet = sheetSelect.value;
      const targetMode = targetModeSel.value;
      if (targetMode === 'both' && !sheet) {
        advNote.textContent = 'âš ï¸ Ø§Ø®ØªØ± ÙˆØ±Ù‚Ø© Ø§Ù„Ù‡Ø¯Ù';
        return;
      }

      google.script.run
        .withSuccessHandler(res => {
          showExecutionSuccess(id, targetMode, res?.message);
          flash(execCard, 'flash-green');
          if (localMap && localMap[id]) {
            localMap[id].aCol = true;
            if (targetMode === 'both') localMap[id].dCol = true;
          }
          markJustColored(id, targetMode);
          if (lastResult) renderResult(lastResult);
          refreshCountsLive();
        })
        .withFailureHandler(err => {
          clearAdvNote();
          advNote.textContent = 'Ø®Ø·Ø£: ' + (err?.message || '');
        })
        .applyAdvancedAction(id, sheet, adminColor.value, withdrawColor.value, targetMode);
    }
    advRunBtn.addEventListener('click', runAdvanced);

    /******** Ø¹Ø¯Ø§Ø¯ / ÙˆØ¶Ø¹ Ø¯Ø§ÙƒÙ† / Ø¥Ø®ÙØ§Ø¡ ØªØ­Ù…ÙŠÙ„ ********/
    function fmtNum(n){ const x=Number(n); return isNaN(x)?'â€”':new Intl.NumberFormat('en-US').format(x); }
    function refreshCountsLive(pctOverride){
      const pct = (typeof pctOverride === 'number') ? pctOverride : Number(discountInput?.value || 0);
      google.script.run
        .withSuccessHandler(res=>{
          if(!res || !res.ok){ qtColored.textContent='â€”'; qtUncolored.textContent='â€”'; return; }
          qtColored.textContent   = fmtNum(res.coloredRows || 0);
          qtUncolored.textContent = fmtNum(res.uncoloredRows || 0);
        })
        .withFailureHandler(()=>{ qtColored.textContent='â€”'; qtUncolored.textContent='â€”'; })
        .getLiveStatsForFooter(pct);
    }
    function applyModeLabel(){
      const isDark = document.body.classList.contains('dark');
      if (qtMode) qtMode.textContent = isDark ? 'â˜€ï¸ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­' : 'ğŸŒ™ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†';
    }
    try { if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark'); } catch(_){}
    applyModeLabel();
    qtMode.addEventListener('click', ()=>{
      const isDark = document.body.classList.toggle('dark');
      applyModeLabel();
      try { localStorage.setItem('darkMode', isDark ? 'true':'false'); } catch(_){}
      closeMenu();
    });
    function applyHideState(){
      const hide = (localStorage.getItem('hide_loadsec') === '1');
      if (loadCardSection) loadCardSection.style.display = hide ? 'none' : '';
      if (qtHide) qtHide.textContent = hide ? 'Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„' : 'Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„';
    }
    applyHideState();
    if (qtHide) qtHide.addEventListener('click', ()=>{
      const cur = localStorage.getItem('hide_loadsec') === '1';
      localStorage.setItem('hide_loadsec', cur ? '0':'1');
      applyHideState();
      closeMenu();
    });
    if (qtRefreshCntBtn) qtRefreshCntBtn.addEventListener('click', ()=>{ refreshCountsLive(); closeMenu(); });

    /******** Ø§Ù„Ø¨Ø­Ø« (Ù…Ø­Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ø³ÙŠØ±ÙØ±) ********/
    let querySeq = 0;
    function normalizeId(v){ return String(v||'').trim(); }

    function buildLocalResult(id){
      if (!localMap || (!localMap[id] && !Object.prototype.hasOwnProperty.call(localMap, id))) {
        // Ù„Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙˆÙƒÙŠÙ„ØŒ ÙŠÙ…ÙƒÙ† ÙŠÙƒÙˆÙ† "Ø§Ø¯Ø§Ø±Ø© ÙÙ‚Ø·" â€” Ù†ØªØ±Ùƒ Ù„Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø­ÙƒÙ…
        return { status:'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', totalSalary:'0.00', salaries:[], id:id, isDuplicate:false };
      }
      const node = localMap[id] || {};
      const inAdmin = !!node.inAdmin;
      const rowsCount = Number(node.rowsCount||0);
      const total = Number(node.sum||0);
      const salaries = Array.isArray(node.salaries) ? node.salaries.map(Number) : [];

      let status = 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
      if (rowsCount > 0) {
        status = inAdmin ? ((rowsCount>1)? 'Ø³Ø­Ø¨ ÙˆÙƒØ§Ù„Ø© - Ø±Ø§ØªØ¨ÙŠÙ†':'Ø³Ø­Ø¨ ÙˆÙƒØ§Ù„Ø©') : ((rowsCount>1)? 'Ø±Ø§ØªØ¨ÙŠÙ†':'ÙˆÙƒØ§Ù„Ø©');
      } else if (inAdmin) {
        status = 'Ø§Ø¯Ø§Ø±Ø©';
      }

      // Ù…ÙƒØ±Ø±ØŸ
      let isDuplicate=false, duplicateLabel=null;
      const aCol = !!node.aCol;
      const dCol = !!node.dCol;
      if (aCol && dCol) { isDuplicate = true; duplicateLabel = 'Ù…ÙƒØ±Ø±'; }
      else if (aCol)    { isDuplicate = true; duplicateLabel = 'Ù…ÙƒØ±Ø± ÙˆÙƒØ§Ù„Ø© ÙÙ‚Ø·'; }
      else if (dCol)    { isDuplicate = true; duplicateLabel = 'Ù…ÙƒØ±Ø± Ø§Ø¯Ø§Ø±Ø© ÙÙ‚Ø·'; }

      return {
        status: status,
        totalSalary: total.toFixed(2),
        salaries: salaries,
        discountAmount: '0.00',
        salaryAfterDiscount: total.toFixed(2),
        id: id,
        isDuplicate: isDuplicate,
        duplicateLabel: duplicateLabel
      };
    }

    function doSearch(){
  const id = String(idInput.value||'').trim();
  if (!id){
    applyBadges('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', null, false);
    amountText.textContent = 'â€”';
    multiText.textContent  = '';
    personNote.textContent = 'â€”';
    personMsg.value = '';
    clearDupUI();
    return;
  }

  saveLastId(id);
  lastBaseId = id;
  renderLoading(); // Ø£Ø¨Ù‚Ù "Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø«â€¦" ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ

  const hasLocal = !!(localMap && Object.prototype.hasOwnProperty.call(localMap, id));
  if (hasLocal){
    // Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙˆÙƒÙŠÙ„: Ø£Ø¹Ø±Ø¶ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙˆØ±Ù‹Ø§ (ÙˆÙƒØ§Ù„Ø©/Ø³Ø­Ø¨ ÙˆÙƒØ§Ù„Ø©/Ø±Ø§ØªØ¨ÙŠÙ†)
    const node = localMap[id];
    const inAdmin   = !!node.inAdmin;
    const rowsCount = Number(node.rowsCount||0);
    const total     = Number(node.sum||0);
    const salaries  = Array.isArray(node.salaries) ? node.salaries.map(Number) : [];
    let status;
    if (rowsCount > 0) status = inAdmin ? ((rowsCount>1)? 'Ø³Ø­Ø¨ ÙˆÙƒØ§Ù„Ø© - Ø±Ø§ØªØ¨ÙŠÙ†':'Ø³Ø­Ø¨ ÙˆÙƒØ§Ù„Ø©')
                                        : ((rowsCount>1)? 'Ø±Ø§ØªØ¨ÙŠÙ†':'ÙˆÙƒØ§Ù„Ø©');
    else status = 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';

    let isDuplicate=false, duplicateLabel=null;
    if (node.aCol && node.dCol) { isDuplicate = true; duplicateLabel = 'Ù…ÙƒØ±Ø±'; }
    else if (node.aCol)         { isDuplicate = true; duplicateLabel = 'Ù…ÙƒØ±Ø± ÙˆÙƒØ§Ù„Ø© ÙÙ‚Ø·'; }
    else if (node.dCol)         { isDuplicate = true; duplicateLabel = 'Ù…ÙƒØ±Ø± Ø§Ø¯Ø§Ø±Ø© ÙÙ‚Ø·'; }

    renderResult({
      status,
      totalSalary: total.toFixed(2),
      salaries,
      names: (Array.isArray(node.names) ? node.names : []),
      name: (Array.isArray(node.names) && node.names.length ? String(node.names[0]||'').trim() : ''),
      discountAmount: '0.00',
      salaryAfterDiscount: total.toFixed(2),
      id,
      isDuplicate,
      duplicateLabel
    });
  }
  // Ø¥Ø°Ø§ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø­Ù„ÙŠÙ‹Ø§ (Ù‚Ø¯ ÙŠÙƒÙˆÙ† "Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø·"): Ù„Ø§ Ù†Ø¹Ø±Ø¶ "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" â€” Ù†Ù†ØªØ¸Ø± Ø±Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ±.

  const mySeq = (++window.__qseq || (window.__qseq=1));
  const pct = Number(discountInput?.value || 0);

  google.script.run
    .withSuccessHandler(res=>{
      if (mySeq !== window.__qseq) return; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©
      if (!res || res.status === 'error'){
        if (res && res.message) renderResult({ status:'error', message: res.message });
        return;
      }
      renderResult(res);
      renderPersonCard(id);
    })
    .withFailureHandler(err=>{
      if (err && err.message) renderResult({ status:'error', message: err.message });
    })
    .searchId(id, pct);
}

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®ØµÙ… Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„Ø§Øª
    (function(){
      if (!discountInput) return;
      let t;
      discountInput.addEventListener('input', ()=>{
        if (t) clearTimeout(t);
        t = setTimeout(()=>{
          if (lastResult) renderResult(lastResult);
          const pct = Math.max(0, Math.min(100, Number(discountInput.value)||0));
          refreshCountsLive(pct);
          if (applyDiscountToMessage?.checked && lastBaseId) rebuildPersonCardUsingLast();
        }, 120);
      });
    })();

    // Ù…Ù‡ÙŠÙ‘Ø¦ Ø³ÙˆÙŠØªØ´ "ØªØµØ­ÙŠØ­ Ø§Ù„Ø±Ø§ØªØ¨"
    function initSalaryCorrectionSwitch(){
      if (!enableSalaryCorrection) return;
      google.script.run
        .withSuccessHandler(res=>{
          try { enableSalaryCorrection.checked = !!(res && res.enabled); } catch(_){}
        })
        .withFailureHandler(()=>{})
        .getSalaryCorrectionEnabled();

      enableSalaryCorrection.addEventListener('change', ()=>{
        const desired = !!enableSalaryCorrection.checked;
        google.script.run
          .withSuccessHandler(res=>{
            if (!res || typeof res.enabled === 'undefined') return;
            if (!!res.enabled !== desired) enableSalaryCorrection.checked = !!res.enabled;
            if (lastBaseId) rebuildPersonCardUsingLast();
          })
          .withFailureHandler(()=>{ enableSalaryCorrection.checked = !desired; })
          .setSalaryCorrectionEnabled(desired ? 1 : 0);
      });
    }

    // Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„
    window.addEventListener('load', ()=>{
      applyPersonVisibility();
      loadLastId();
      loadData();
      fillSheets();
      handleBulkIdsChange();
      updateBulkButtons();
      initSalaryCorrectionSwitch();
      setTimeout(refreshCountsLive, 600);
    });
    window.renderResult = renderResult;
    window.renderLoading = renderLoading;
    window.justColored = justColored;
  })();
  </script>
  <!-- ===== /Bulk IDs â€” Advanced ===== -->
  <!-- Ø´Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª (ÙØ­Øµ Ø°ÙƒÙŠØŒ Ù„Ø§ ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙ†ÙÙŠØ° Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø·Ø¡) -->
<style>
  #netBadge{position:fixed;inset-inline-end:12px;inset-block-end:12px;z-index:9999;padding:6px 10px;border-radius:10px;font-size:12px;font-weight:700;box-shadow:0 4px 12px rgba(0,0,0,.15);background:#e5fbe5;border:1px solid #c6f6c6;color:#0b1020;display:flex;align-items:center;gap:6px}
  #netBadge.net-weak{background:#fff8e5;border-color:#ffe7a8;color:#6b4e00}
  #netBadge.net-down{background:#ffe5e5;border-color:#ffc2c2;color:#6b0000}
  #netBadge .dot{width:8px;height:8px;border-radius:50%;background:#16a34a}
  #netBadge.net-weak .dot{background:#f59e0b}
  #netBadge.net-down .dot{background:#ef4444}
</style>
<div id="netBadge"><span class="dot"></span><span id="netText">ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„â€¦</span></div>

<script>
(function(){
  const badge=document.getElementById('netBadge');
  const text=document.getElementById('netText');

  function setState(kind,label){
    badge.classList.remove('net-weak','net-down');
    if(kind==='ok'){ text.textContent=`Ù…ØªØµÙ„ âœ… ${label||''}`.trim(); }
    else if(kind==='weak'){ badge.classList.add('net-weak'); text.textContent=`Ø¨Ø·ÙŠØ¡ ğŸŸ¡ ${label||''}`.trim(); }
    else { badge.classList.add('net-down'); text.textContent=`Ø£ÙˆÙÙ„Ø§ÙŠÙ† â›” ${label||''}`.trim(); }
  }

  function pingServer(timeoutMs){
    return new Promise(res=>{
      let done=false, t0=performance.now();
      try{
        google.script.run
          .withSuccessHandler(()=>{ if(done) return; done=true; res({ok:true,rtt:performance.now()-t0}); })
          .withFailureHandler(()=>{ if(done) return; done=true; res({ok:false}); })
          .ping?.();
        setTimeout(()=>{ if(done) return; done=true; res({ok:false}); }, timeoutMs||2000);
      }catch(_){ res({ok:false}); }
    });
  }

  let lastPing=0;
  async function checkNow(){
    // ÙØ­Øµ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© (Ø³Ù†ÙØ¹Ù‘Ù„Ù‡ Ø¨Ø§Ù„interval Ø¨Ø§Ù„Ø£Ø³ÙÙ„)
    if(!navigator.onLine){ setState('down','(Ø§Ù„Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…ØªØµÙ„)'); window.__serverReachable=false; return; }

    // ÙØ­Øµ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© ÙÙ‚Ø·
    const now=Date.now();
    if(now-lastPing>30000){
      lastPing=now;
      const s=await pingServer(1500);
      if(s.ok){
        const rtt=Math.round(s.rtt||0);
        if(rtt<=700) setState('ok',`(${rtt}ms)`); else setState('weak',`(${rtt}ms)`);
        window.__serverReachable=true;   // Ù†Ø³ØªÙÙŠØ¯ Ù…Ù†Ù‡Ø§ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
      }else{
        setState('weak','()'); // Ø¹Ø±Ø¶ ÙÙ‚Ø·Ø› Ù…Ø§ ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙ†ÙÙŠØ°
        window.__serverReachable=false;
      }
    }
  }

  // ÙØ­Øµ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© + Ø§Ù„Ø³ÙŠØ±ÙØ± ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
  setInterval(checkNow,1000);
  checkNow();
  window.addEventListener('online',()=>{ lastPing=0; checkNow(); });
  window.addEventListener('offline',()=> setState('down','(Ø§Ù„Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…ØªØµÙ„)'));

  // ğŸ” Ø£Ù‡Ù… ØªØºÙŠÙŠØ±: Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ†ÙÙŠØ° Ù…Ø§ Ø¯Ø§Ù… Ø§Ù„Ø¬Ù‡Ø§Ø² Online Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø·ÙŠØ¡
  window.netEnsureOnline = async function(){
    // Ù„Ùˆ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø£ÙˆÙÙ„Ø§ÙŠÙ† ÙÙ‚Ø· Ù†Ù…Ù†Ø¹
    if(!navigator.onLine){
      alert('â›” Ø§Ù„Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
      return false;
    }
    // Ø®Ù„Ø§Ù Ø°Ù„Ùƒ Ù†Ø³Ù…Ø­ Ø¯ÙˆÙ…Ù‹Ø§ (Ø³Ø±ÙŠØ¹ Ø£Ùˆ Ø¨Ø·ÙŠØ¡ / Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØªØ£Ø®Ø± Ø¨Ø§Ù„Ø±Ø¯)
    return true;
  };
})();
</script>
<script>
/* Ø­Ø§Ø±Ø³ Ø²Ø± Ø§Ù„ØªÙ†ÙÙŠØ° â€” ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙ†ÙÙŠØ° Ù„Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ ØºÙŠØ± Ø¬Ø§Ù‡Ø² (Ø¨Ø¯ÙˆÙ† Ù„Ù…Ø³ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ) */
(function guardExecButton(){
  const SELECTORS = ['#advRunBtn']; // Ø£Ø¶Ù Ø£Ø²Ø±Ø§Ø± Ø£Ø®Ø±Ù‰ Ù‡Ù†Ø§ Ù„Ùˆ ØªØ­Ø¨

  function isServerLikelyUp(){
    if (window.__serverReachable === true)  return true;
    if (window.__serverReachable === false) return false;
    return navigator.onLine; // ØªÙ‚Ø¯ÙŠØ± Ø³Ø±ÙŠØ¹
  }

  async function ensureOnlineInteractive(){
    if (typeof window.netEnsureOnline === 'function'){
      return await window.netEnsureOnline();
    }
    if (!navigator.onLine){ alert('â›” Ø§Ù„Ø¬Ù‡Ø§Ø² Ø£ÙˆÙÙ„Ø§ÙŠÙ† â€” Ù„Ù† ÙŠØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°.'); return false; }
    if (window.__serverReachable === false){ alert('ğŸŸ¡ Ø§Ù„Ø³ÙŠØ±ÙØ± ØºÙŠØ± Ù…ØªØ§Ø­ â€” Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ Ø­Ø¯Ù‘Ø« Ø§Ù„ØµÙØ­Ø©.'); return false; }
    return true;
    }

  function handlerCapture(e){
    const btn = e.target.closest(SELECTORS.join(','));
    if (!btn) return;
    e.preventDefault();
    e.stopImmediatePropagation();

    (async ()=>{
      if (!isServerLikelyUp()){
        const ok = await ensureOnlineInteractive();
        if (!ok) return;
      } else {
        const ok = await ensureOnlineInteractive();
        if (!ok) return;
      }
      // Ù…Ø±Ù‘Øª Ø§Ù„Ø´Ø±ÙˆØ· âœ… â€” Ø£Ø¹Ø¯ Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ù‚Ø± Ù„ÙŠÙƒÙ…Ù„ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ
      document.removeEventListener('click', handlerCapture, true);
      try { btn.click(); } finally {
        setTimeout(()=> document.addEventListener('click', handlerCapture, true), 0);
      }
    })();
  }

  document.addEventListener('click', handlerCapture, true);
})();
</script>
<!-- ======= Ø³Ø¬Ù„ Ø§Ù„Ù†Ù‚Ù„ â€” ÙˆØ§Ø¬Ù‡Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© ======= -->
<style>
  .lgp-btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:12px 14px;border:1px solid #16a34a;background:#22c55e;color:#fff;
    font-weight:800;cursor:pointer;width:100%;margin:10px 0;border-radius:12px}
  .lgp-btn:disabled{opacity:.6;cursor:not-allowed}

  .lgp-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
    background:rgba(0,0,0,.35);z-index:99999}
  .lgp-modal.show{display:flex}
  .lgp-sheet{width:min(92vw,560px);padding:14px;background:var(--card-bg,#111827);color:var(--fg,#e5e7eb);
    box-shadow:0 12px 28px rgba(0,0,0,.25);border:1px solid var(--border,#374151);border-radius:12px;overflow:hidden}
  .lgp-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .lgp-title h3{margin:0;font-size:16px;font-weight:800}
  .lgp-ghost{border:1px solid var(--border,#374151);background:transparent;padding:8px 12px;color:inherit;border-radius:12px}

  .lgp-list{max-height:56vh;overflow:auto;border:1px solid var(--border,#374151);background:rgba(255,255,255,.02);border-radius:12px}
  .lgp-row{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:10px;border-bottom:1px solid var(--border,#374151)}
  .lgp-row:last-child{border-bottom:0}
  .lgp-id{font-family:ui-monospace,monospace;font-weight:800}
  .lgp-meta{font-size:11px;opacity:.8}

  .lgp-controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .lgp-select,.lgp-color{border:1px solid var(--border,#374151);background:transparent;color:inherit;padding:10px;border-radius:12px}
  .lgp-primary{background:#22c55e;border:1px solid #16a34a;color:#fff;padding:12px;font-weight:800;border-radius:12px}

  .lgp-toggle{display:inline-flex;align-items:center;gap:10px}
  .ios-switch{position:relative;width:48px;height:28px}
  .ios-switch input{appearance:none;-webkit-appearance:none;width:48px;height:28px;margin:0;cursor:pointer}
  .ios-switch .track{position:absolute;inset:0;background:#6b7280;transition:.2s;border-radius:999px}
  .ios-switch .thumb{position:absolute;top:3px;left:3px;width:22px;height:22px;background:#fff;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.25);transition:.2s}
  .ios-switch input:checked ~ .track{ background:#22c55e }
  .ios-switch input:checked ~ .thumb{ left:23px }

  .lgp-color{ width:44px;height:34px;padding:0 }
  .lgp-hint{font-size:12px;opacity:.75;margin-top:6px}
</style>

<!-- Ø²Ø± "Ø§Ù„Ø³Ø¬Ù„" (ÙŠÙØ²Ø±ÙØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ØªØ­Øª Ø²Ø± Ø§Ù„ØªÙ†ÙÙŠØ°) -->
<div id="lgpMount" style="display:none">
  <button id="lgpOpen" class="lgp-btn">ğŸ“ Ø§Ù„Ø³Ø¬Ù„</button>
</div>

<!-- Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
<div id="lgpModal" class="lgp-modal" role="dialog" aria-modal="true">
  <div class="lgp-sheet">
    <div class="lgp-title">
      <h3>ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ù†Ù‚Ù„ (Ø¢Ø®Ø± 15)</h3>
      <button id="lgpClose" class="lgp-ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div id="lgpList" class="lgp-list">
      <div class="lgp-row"><div></div><div>â€¦ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„</div><div></div></div>
    </div>

    <div class="lgp-controls">
      <select id="lgpTarget" class="lgp-select" title="Ø§Ø®ØªØ± ÙˆØ±Ù‚Ø© Ø§Ù„Ù‡Ø¯Ù">
        <option>â€¦ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>
      </select>

      <div class="lgp-toggle">
        <span style="font-size:12px;opacity:.8">Ù„ÙˆÙ† Ù…Ø®ØµÙ‘Øµ</span>
        <label class="ios-switch">
          <input id="lgpUseCustom" type="checkbox">
          <span class="track"></span><span class="thumb"></span>
        </label>
      </div>
      <input id="lgpColor" type="color" class="lgp-color" value="#ddd6fe" title="Ù„ÙˆÙ† Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ù‚Ù„" disabled>

      <button id="lgpMove" class="lgp-primary">Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
    </div>

    <div id="lgpHint" class="lgp-hint"></div>
  </div>
</div>

<script>
/* Ø²Ø±Ø¹ Ø²Ø± Ø§Ù„Ø³Ø¬Ù„ ØªØ­Øª Ø²Ø± ØªÙ†ÙÙŠØ° (Ø­Ø³Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©) */
(function(){
  var mount = document.getElementById('lgpMount');
  function resolveHost(){
    if (!mount) return null;
    var anchor = document.getElementById('logAnchor');
    if (anchor) return anchor;
    var mobile = document.body.classList.contains('bulk-mobile-active') && window.matchMedia('(max-width: 1200px)').matches;
    if (mobile){
      var mobileHost = document.getElementById('bulkMobileMount');
      if (mobileHost) return mobileHost;
    }
    var runBtn=document.getElementById('advRunBtn');
    var host = runBtn ? runBtn.closest('.card') : null;
    if(!host) host=document.getElementById('execCard');
    if(!host){
      var cards=document.querySelectorAll('.card');
      if(cards.length) host=cards[cards.length-1];
    }
    if(!host) host=document.body;
    return host;
  }
  function placeButton(){
    if(!mount) return;
    var host = resolveHost();
    if(!host) return;
    var mobileHost = document.getElementById('bulkMobileMount');
    if(host === mobileHost){
      if(mount.parentNode!==host || host.firstChild!==mount){
        host.insertBefore(mount, host.firstChild || null);
      }
    } else {
      if(mount.parentNode!==host) host.appendChild(mount);
    }
    mount.style.display='block';
  }
  function ensureMounted(){
    placeButton();
    setTimeout(placeButton,150); setTimeout(placeButton,400); setTimeout(placeButton,1000);
    window.addEventListener('resize',()=>setTimeout(placeButton,150));
    document.addEventListener('bulk-mobile-state-change', ()=>setTimeout(placeButton,50));
    new MutationObserver(()=>placeButton()).observe(document.body,{childList:true,subtree:true});
  }
  (document.readyState==='loading') ? document.addEventListener('DOMContentLoaded',ensureMounted) : ensureMounted();
})();

/* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø¬Ù„ */
(function(){
  var modal=document.getElementById('lgpModal');
  var openBtn=document.getElementById('lgpOpen');
  var closeBtn=document.getElementById('lgpClose');
  var list=document.getElementById('lgpList');
  var sel=document.getElementById('lgpTarget');
  var useCustom=document.getElementById('lgpUseCustom');
  var colorInp=document.getElementById('lgpColor');
  var move=document.getElementById('lgpMove');
  var hint=document.getElementById('lgpHint');

  function setHint(msg){ if(hint) hint.textContent = msg || ''; }

  function renderList(items){
    list.innerHTML='';
    if(!items||!items.length){
      list.innerHTML='<div class="lgp-row"><div></div><div>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„</div><div></div></div>';
      list.__rows__=[];
      return;
    }
    items.forEach(function(it,i){
      var row=document.createElement('div');
      row.className='lgp-row';
      row.innerHTML = `
        <label><input type="checkbox" data-idx="${i}"></label>
        <div>
          <div class="lgp-id">${it.id||'â€”'} | ${it.target||'â€”'}</div>
          <div class="lgp-meta">${it.at||''} â€¢ ØµÙÙˆÙ: ${it.rows||1}</div>
        </div>
        <div style="width:18px;height:18px;border:1px solid var(--border,#374151);border-radius:6px;background:${it.color||'transparent'}"></div>
      `;
      list.appendChild(row);
    });
    list.__rows__ = items || [];
  }

  function loadAll(){
    list.innerHTML='<div class="lgp-row"><div></div><div>â€¦ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„</div><div></div></div>';
    sel.innerHTML='<option>â€¦ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>';
    setHint('ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø£ÙˆØ±Ø§Ù‚â€¦');

    // Ø§Ù„Ø³Ø¬Ù„
    google.script.run
      .withSuccessHandler(function(items){ renderList(items||[]); setHint(''); })
      .withFailureHandler(function(err){
        list.innerHTML='<div class="lgp-row"><div></div><div>âš ï¸ Ø®Ø·Ø£ getMoveLogLatest: '+(err&&err.message||'')+'</div><div></div></div>';
        list.__rows__=[];
        setHint('');
      })
      .getMoveLogLatest(15);

    // Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ (ÙŠØ³ØªØ®Ø¯Ù… getAdminSheetsSafeØŒ ÙˆØ¥Ù† ÙØ´Ù„ ÙŠØ­Ø§ÙˆÙ„ getAdminSheets)
    google.script.run
      .withSuccessHandler(function(arr){
        sel.innerHTML='';
        (arr||[]).forEach(function(n){
          var o=document.createElement('option'); o.value=o.textContent=n; sel.appendChild(o);
        });
        var sheetSelect=document.getElementById('sheetSelect');
        if(sheetSelect && sheetSelect.value) sel.value = sheetSelect.value;
      })
      .withFailureHandler(function(){
        google.script.run
          .withSuccessHandler(function(arr){
            sel.innerHTML='';
            (arr||[]).forEach(function(n){
              var o=document.createElement('option'); o.value=o.textContent=n; sel.appendChild(o);
            });
          })
          .withFailureHandler(function(err){
            sel.innerHTML=''; var o=document.createElement('option');
            o.textContent='âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚: '+(err&&err.message||''); sel.appendChild(o);
          })
          .getAdminSheets();
      })
      .getAdminSheetsSafe();
  }

  // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚
  openBtn && openBtn.addEventListener('click', ()=>{ loadAll(); modal.classList.add('show'); });
  closeBtn && closeBtn.addEventListener('click', ()=> modal.classList.remove('show'));
  modal.addEventListener('click', e=>{ if(e.target===modal) modal.classList.remove('show'); });

  // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ù„ÙˆÙ† Ù…Ø®ØµØµ
  function syncColor(){ colorInp.disabled = !useCustom.checked; colorInp.style.opacity = useCustom.checked ? '1' : '.55'; }
  useCustom && useCustom.addEventListener('change', syncColor); syncColor();

  // Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯
  move && move.addEventListener('click', function(){
    var checks = Array.from(list.querySelectorAll('input[type=checkbox]:checked'));
    if(!checks.length){ alert('Ø§Ø®ØªØ± Ø¹Ù†Ø§ØµØ± Ù„Ù„Ù†Ù‚Ù„'); return; }
    var rows = list.__rows__ || [];
    var pick = checks.map(function(ch){ var r=rows[+ch.dataset.idx]||{}; return { id:(r.id||''), from:(r.target||'') }; });
    var override = useCustom && useCustom.checked ? (colorInp.value||'') : '';

    move.disabled=true; move.textContent='Ø¬Ø§Ø±Ù Ø§Ù„Ù†Ù‚Ù„â€¦';
    google.script.run
      .withSuccessHandler(function(res){
        move.disabled=false; move.textContent='Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯';
        alert(res && res.message ? res.message : 'ØªÙ….');
        loadAll();
      })
      .withFailureHandler(function(err){
        move.disabled=false; move.textContent='Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯';
        alert('Ø®Ø·Ø£: '+(err&&err.message||'')); 
      })
      .moveFromLog(pick, sel.value||'', override);
  });
})();
</script>
<?!= HtmlService.createHtmlOutputFromFile('AIClient').getContent(); ?>
</script>
<!-- âœ… ØªØ±ØªÙŠØ¨ Ù…ÙˆØ­Ù‘Ø¯ + ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© + ØªÙ†Ø³ÙŠÙ‚ ØµÙ Ø§Ù„Ø¨Ø­Ø« -->
<script>
(function(){
  const quickTools = document.getElementById('quickTools');
  const execCard = document.getElementById('execCard');
  const personCard = document.getElementById('personCard');
  const bulkCard = document.getElementById('bulkCard');
  const searchCard = document.getElementById('searchCard');

  function isVisible(el){
    if (!el) return false;
    const style = getComputedStyle(el);
    if (style.display === 'none' || style.visibility === 'hidden' || Number(style.opacity) === 0) return false;
    if (el.offsetParent === null && style.position !== 'fixed') return false;
    return true;
  }

  function placeQuickTools(){
    if (!quickTools || !execCard) return;
    const anchor = (personCard && isVisible(personCard)) ? personCard : execCard;
    if (!anchor || !anchor.parentNode) return;
    const parent = anchor.parentNode;
    if (quickTools.parentNode !== parent) {
      parent.insertBefore(quickTools, anchor.nextSibling);
    } else if (quickTools.previousElementSibling !== anchor) {
      parent.insertBefore(quickTools, anchor.nextSibling);
    }
  }

  function placeBulkCard(){
    if (!quickTools || !bulkCard) return;
    const parent = quickTools.parentNode;
    if (!parent) return;
    if (bulkCard.parentNode !== parent) {
      parent.insertBefore(bulkCard, quickTools.nextSibling);
    } else if (bulkCard.previousElementSibling !== quickTools) {
      parent.insertBefore(bulkCard, quickTools.nextSibling);
    }
  }

  function fixSearchRow(){
    if (!searchCard) return;
    const row = searchCard.querySelector('#searchPasteRow') || searchCard.querySelector('.paste-row') || searchCard.querySelector('.row');
    const input = document.getElementById('idInput');
    const button = document.getElementById('pasteSearchBtn');
    if (!row) return;
    row.classList.add('paste-row');
    if (input && input.parentNode !== row) {
      row.insertBefore(input, row.firstChild);
    }
    if (button && button.parentNode !== row) {
      row.appendChild(button);
    }
  }

  function fixBulkRow(){
    if (!bulkCard) return;
    const row = document.getElementById('bulkPasteRow');
    const textarea = document.getElementById('bulkIds');
    const pasteBtn = document.getElementById('bulkPasteBtn');
    if (!row) return;
    row.classList.add('bulk-paste-grid');
    if (textarea && textarea.parentNode !== row) {
      row.insertBefore(textarea, row.firstChild);
    }
    if (pasteBtn && pasteBtn.parentNode !== row) {
      row.appendChild(pasteBtn);
    }
  }

  function run(){
    placeQuickTools();
    placeBulkCard();
    fixSearchRow();
    fixBulkRow();
  }

  function init(){
    run();
    const observer = new MutationObserver(run);
    observer.observe(document.body, { childList:true, subtree:true, attributes:true, attributeFilter:['style','class'] });
    window.addEventListener('resize', run);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init, { once:true });
  } else {
    init();
  }
})();
</script>
<script>
(function(){
  if (typeof renderResult !== 'function') return;
  const _orig = renderResult;

  renderResult = function(res){
    // Ø§Ø±Ø³Ù… Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ (Ø§Ù„Ø±Ø§ØªØ¨/Ø§Ù„Ø­Ø§Ù„Ø©â€¦)
    _orig(res);

    // Ø«Ù… Ø¹Ø²Ù‘Ø² "Ù…ÙƒØ±Ø±" Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙˆØ±Ù‹Ø§
    try{
      const dupBadge = document.getElementById('dupBadge'); // Ø´Ø§Ø±Ø© "Ù…ÙƒØ±Ø±" Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      const id = (res && res.id) ? String(res.id).trim() : '';

      // Ù„Ùˆ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø³Ù‡ Ù…Ø§ Ø±Ø¬Ù‘Ø¹ "Ù…ÙƒØ±Ø±"ØŒ Ø¨Ø³ Ù†Ø­Ù†Ø§ Ø´Ø§ÙŠÙÙŠÙ† ØªÙ†ÙÙŠØ° ÙÙˆØ±ÙŠ Ù„Ù‡Ø§Ù„Ù€ID
      const serverSaysDup = !!(res && (res.isDuplicate || res.dupFlavor));
      if (id && justColored[id] && !serverSaysDup) {
        if (dupBadge){
          dupBadge.style.display = '';
          dupBadge.textContent = (justColored[id] === 'both') ? 'Ù…ÙƒØ±Ø±' : 'Ù…ÙƒØ±Ø± ÙˆÙƒØ§Ù„Ø© ÙÙ‚Ø·';
        }
        // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø§Ù…Ø³Ø­ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ø¥Ø¸Ù‡Ø§Ø± Ù„Ø­ØªÙ‰ Ù…Ø§ ØªØ¶Ù„ Ù…Ø¹Ùƒ
        // delete justColored[id];
      } else if (dupBadge && !serverSaysDup) {
        // Ù…Ø§ ÙÙŠ Ù„Ø§ Ù…Ø­Ù„ÙŠ ÙˆÙ„Ø§ Ø³ÙŠØ±ÙØ± â†’ Ø£Ø®ÙÙ Ø§Ù„Ø´Ø§Ø±Ø©
        dupBadge.style.display = 'none';
      }
    }catch(_){}
  };

  // Ù†Ø¸Ø§ÙØ© Ø¨ØµØ±ÙŠØ©: Ù„Ù…Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„Ù€ID Ø£Ùˆ ÙŠØ¨Ø¯Ø£ Ø¨Ø­Ø« Ø¬Ø¯ÙŠØ¯ Ø§Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Ø±Ø© Ø¨Ø³Ø±Ø¹Ø©
  try {
    const idInput = document.getElementById('idInput');
    if (idInput){
      idInput.addEventListener('input', ()=>{
        const dupBadge = document.getElementById('dupBadge');
        if (dupBadge) dupBadge.style.display = 'none';
      });
    }
    if (typeof renderLoading === 'function'){
      const _rl = renderLoading;
      renderLoading = function(){
        _rl();
        const dupBadge = document.getElementById('dupBadge');
        if (dupBadge) dupBadge.style.display = 'none';
      };
    }
  } catch (_){}
})();
</script>
</body>
</html>
